<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fugth AI Anvil | The Future of AI Companions</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "t4j0cphhgn");
    </script>

    <style>
        :root {
            /* Modern Cyber Theme */
            --color-background: #010409;
            --color-surface: #0d1117;
            --color-surface-light: #161b22;
            --color-border: rgba(217, 249, 157, 0.1);
            --color-primary: #d9f99d; /* Cyber Lime */
            --color-secondary: #7ee787; /* Green */
            --color-text-primary: #e6edf3;
            --color-text-secondary: #7d8590;
            --color-text-heading: #ffffff;
            --color-favorite: #facc15;
            --color-error: #f85149;
            --font-family: 'Inter', sans-serif;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.2);
            
            /* AI Customization Variables */
            --ai-body-color: #d9f99d;
            --ai-eye-color: #010409;
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(217, 249, 157, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(217, 249, 157, 0); } 100% { box-shadow: 0 0 0 0 rgba(217, 249, 157, 0); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes run-off { to { transform: translate(200vw, -200vh) rotate(720deg) scale(0.5); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
        @keyframes torso-sway { 0%, 100% { transform: translateX(-50%) rotate(0deg); } 50% { transform: translateX(-50%) rotate(2deg); } }
        @keyframes arm-sway { 0%, 100% { transform: rotate(-20deg); } 50% { transform: rotate(-15deg); } }
        @keyframes arm-sway-right { 0%, 100% { transform: rotate(20deg); } 50% { transform: rotate(15deg); } }
        @keyframes leg-dangle { 0%, 100% { transform: rotate(10deg); } 50% { transform: rotate(15deg); } }
        @keyframes leg-dangle-right { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(-15deg); } }


        /* General & Theme Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {  
            font-family: var(--font-family);   
            background-color: var(--color-background);   
            color: var(--color-text-primary);   
            line-height: 1.6;   
            -webkit-font-smoothing: antialiased;   
            position: relative;
            overflow-x: hidden;
            background-image:
                linear-gradient(rgba(217, 249, 157, 0.05) 1px, transparent 1px),
                linear-gradient(to right, rgba(217, 249, 157, 0.05) 1px, transparent 1px);
            background-size: 3rem 3rem;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-surface); }
        ::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-secondary); }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }
        section { padding: 100px 0; border-bottom: 1px solid var(--color-border); position: relative; }
        section:last-of-type { border-bottom: none; }
        
        h1, h2, h3 { font-weight: 700; line-height: 1.2; color: var(--color-text-heading); letter-spacing: -0.03em; }
        h1 { font-size: clamp(2.5rem, 5vw + 1rem, 4rem); } 
        h2 { font-size: clamp(2rem, 4vw + 1rem, 2.5rem); } 
        h3 { font-size: 1.75rem; }
        p { color: var(--color-text-secondary); margin-bottom: 1rem; }
        
        .section-header { text-align: center; max-width: 700px; margin: 0 auto 60px auto; }
        .text-gradient { background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; text-align: center; }
        .btn:disabled { background: #374151 !important; color: #6B7280 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; border-color: transparent !important; }
        .btn-primary { background: var(--color-primary); color: #010409; border-color: var(--color-primary); }
        .btn-primary:hover { background: var(--color-secondary); border-color: var(--color-secondary); transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(217, 249, 157, 0.2); }
        .btn-secondary { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-primary); }
        .btn-secondary:hover, .btn-secondary.active { background: var(--color-primary); border-color: var(--color-primary); color: #010409; }
        .hidden { display: none !important; }

        header { position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; transition: background 0.3s ease, border-color 0.3s ease; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid transparent; }
        header.scrolled { background: rgba(1, 4, 9, 0.7); border-bottom-color: var(--color-border); }
        nav { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; }
        .logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; color: var(--color-text-primary); cursor: pointer; }
        .nav-links { list-style: none; display: flex; gap: 32px; }
        .nav-links a { text-decoration: none; color: var(--color-text-secondary); font-weight: 500; transition: color 0.2s ease; cursor: pointer; padding-bottom: 4px; border-bottom: 2px solid transparent; }
        .nav-links a:hover, .nav-links a.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .auth-container { display: flex; align-items: center; gap: 12px; }
        .mobile-menu-toggle { display: none; }
        
        .avatar-display { width: 32px; height: 32px; position: relative; }
        .avatar-display .avatar-base { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--color-surface-light); border: 2px solid var(--color-primary); }
        .avatar-display .avatar-base img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-display .avatar-base i { font-size: 1.2rem; color: var(--color-primary); }

        #hero-page { min-height: 100vh; display: flex; align-items: center; text-align: center; padding-top: 80px; }
        .hero-content { max-width: 800px; margin: 0 auto; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .market-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; position: relative; cursor: pointer;}
        .market-card:hover { transform: translateY(-8px); border-color: var(--color-primary); box-shadow: 0 0 30px rgba(217, 249, 157, 0.1); }
        .market-card.equipped { border-color: var(--color-secondary); box-shadow: 0 0 15px rgba(126, 231, 135, 0.2); }
        .card-image { height: 160px; display: flex; align-items: center; justify-content: center; font-size: 3rem; background: var(--color-background); color: var(--color-primary); }
        .card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); margin-bottom: 0.25rem; }
        .card-creator { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 0.75rem; }
        .card-description {
            font-size: 0.9rem; color: var(--color-text-secondary); flex-grow: 1;
            line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3;
            -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;
        }
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 0 1rem 1rem 1rem; font-size: 1rem; font-weight: 600; margin-top: auto; }
        .card-footer > * { cursor: pointer; } /* Make buttons clickable inside card */
        
        /* Marketplace & Inventory Category Filters */
        .category-filters { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2.5rem; flex-wrap: wrap; }
        
        /* --- AI Customizer Styles --- */
        .customizer-layout { display: grid; grid-template-columns: 1fr 350px; gap: 3rem; align-items: center; }
        .customizer-preview { background: var(--color-background); border: 1px solid var(--color-border); border-radius: 16px; padding: 3rem; display: flex; justify-content: center; align-items: center; position: relative; min-height: 450px; }
        .preview-ai-container { position: relative; width: 180px; height: 300px; }
        .preview-ai-container .ai-character-rig { animation: float 4s ease-in-out infinite; }

        .customizer-controls { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 2rem; }
        .control-group { margin-bottom: 1.5rem; }
        .control-group label { display: block; font-weight: 500; color: var(--color-text-secondary); margin-bottom: 0.75rem; }
        .color-input-wrapper { display: flex; align-items: center; gap: 1rem; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 48px; height: 48px; background-color: transparent; border: none; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--color-border); }
        input[type="color"]::-moz-color-swatch { border-radius: 50%; border: 2px solid var(--color-border); }
        .color-value { font-family: 'Courier New', Courier, monospace; background: var(--color-background); padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid var(--color-border); }
        #save-customizations-btn { width: 100%; margin-top: 1rem; }
        @media (max-width: 992px) { .customizer-layout { grid-template-columns: 1fr; } }
        
        /* Modal - Right Side Panel */
        .modal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: rgba(1, 4, 9, 0.5); backdrop-filter: blur(8px);
            display: flex; justify-content: flex-end; /* Align to the right */
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s;
        }
        .modal-container.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--color-surface);
            border-left: 1px solid var(--color-border);
            width: 100%; max-width: 420px; height: 100%;
            position: relative; transform: translateX(100%);
            display: flex; flex-direction: column;
        }
        .modal-header { padding: 2rem 2rem 1rem; }
        .modal-body { padding: 0 2rem 2rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1.5rem 2rem; border-top: 1px solid var(--color-border); margin-top: auto; }

        .modal-container.show .modal-content { animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .modal-container.closing .modal-content { animation: slideOutRight 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }

        .modal-close {
            position: absolute; top: 1.5rem; right: 1.5rem; background: var(--color-surface-light);
            border-radius: 50%; width: 32px; height: 32px; display: flex;
            align-items: center; justify-content: center; cursor: pointer; font-size: 1rem;
            transition: background-color 0.2s; z-index: 10;
        }
        .modal-close:hover { background-color: var(--color-background); }

        .auth-form { display:flex; flex-direction:column; gap: 1rem; margin-top: 1.5rem; }
        .auth-form input { background: var(--color-background); border: 1px solid var(--color-border); padding: 0.75rem; border-radius: 6px; color: var(--color-text-primary); font-size: 1rem; }
        
        /* Item Details Modal Styles */
        .item-details-icon { font-size: 5rem; text-align: center; margin-bottom: 1.5rem; color: var(--color-primary); }
        .item-details-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .item-details-tag { background: var(--color-surface-light); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; }

        /* Profile Page */
        .profile-content { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-top: 2rem; align-items: start; }
        .profile-sidebar { background: var(--color-surface); border-radius: 12px; padding: 2rem; border: 1px solid var(--color-border); position: sticky; top: 100px; text-align:center;}
        #profile-avatar-wrapper { width: 150px; height: 150px; margin: 0 auto 1rem; position: relative; }
        #profile-avatar-wrapper .avatar-display { width: 100%; height: 100%; }
        #profile-avatar-wrapper .avatar-display .avatar-base { font-size: 6rem; }
        .avatar-change-btn { position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; border-radius: 50%; background: var(--color-primary); border: none; color: #010409; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; font-size: 1rem; }
        .profile-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-text-primary); }
        .stat-label { font-size: 0.875rem; color: var(--color-text-secondary); }
        .profile-main { display: flex; flex-direction: column; gap: 2rem; }
        .profile-section { background: var(--color-surface); border-radius: 12px; padding: 2rem; border: 1px solid var(--color-border); }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
        .form-group label { text-align: left; }
        .form-group input { padding: 0.75rem; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-surface-light); color: var(--color-text-primary); font-size: 1rem; }
        #personalInfoForm button { margin-top: 1rem; }

        /* FLOATING AI STYLES */
        #floating-ai-container { position: fixed; z-index: 1001; width: 85px; height: 140px; cursor: grab; transition: top 2s ease-in-out, left 2s ease-in-out; display: flex; align-items: center; justify-content: center; }
        #floating-ai-container.dragging, #floating-ai-container.needy { transition: none; }
        #floating-ai-container.running-off { animation: run-off 0.7s ease-in forwards; }
        #floating-ai-container:not(.needy):not(.dragging) { animation: breathe 3s ease-in-out infinite; }
        #floating-ai-container:active:not(.needy) { cursor: grabbing; animation: none; }
        
        .ai-character-rig { width: 100%; height: 100%; position: relative; }
        
        /* Head */
        .ai-body { width: 82%; height: 70px; position: absolute; left: 50%; transform: translateX(-50%); top: 0; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .ai-skin-layer { position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; background: var(--ai-body-color); box-shadow: inset 0 -5px 15px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 50px; color: var(--ai-body-color); transition: all 0.3s ease; border: 4px solid var(--color-surface); outline: 2px solid var(--ai-body-color); }
        .ai-skin-layer.icon-active { background: transparent; box-shadow: none; text-shadow: 0 0 10px var(--ai-body-color); }
        
        /* Torso */
        .ai-torso { position: absolute; left: 50%; transform: translateX(-50%); background: var(--ai-body-color); border: 2px solid var(--ai-body-color); background-color: var(--color-surface); border-radius: 20px 20px 15px 15px; box-shadow: none; transition: background-color 0.3s ease; z-index: 5; }
        .ai-torso::before { content: ''; position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; background: var(--ai-body-color); border-radius: 12px; box-shadow: inset 0 -4px 8px rgba(0,0,0,0.25); }
        #floating-ai-container:not(.needy):not(.dragging) .ai-torso { animation: torso-sway 3s ease-in-out infinite; animation-delay: -1.5s; }

        /* Joints */
        .ai-arm::after, .ai-leg::after { content: ''; position: absolute; left: 50%; transform: translateX(-50%); background: var(--ai-body-color); border: 2px solid var(--color-surface); border-radius: 50%; z-index: 6; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Arms & Legs */
        .ai-arm, .ai-leg { position: absolute; background: var(--ai-body-color); box-shadow: inset 0 2px 8px rgba(0,0,0,0.2); z-index: 1; transform-origin: top center; border-radius: 10px; }
        .ai-arm-left { transform: rotate(-20deg); }
        .ai-arm-right { transform: rotate(20deg); }
        .ai-leg-left { transform: rotate(10deg); }
        .ai-leg-right { transform: rotate(-10deg); }

        /* Hands & Feet */
        .ai-hand, .ai-foot { position: absolute; background: var(--ai-body-color); border-radius: 50%; box-shadow: inset 0 -4px 8px rgba(0,0,0,0.2); left: 50%; transform: translateX(-50%); }
        .ai-foot { border-radius: 10px; }

        /* --- Sizing & Positioning for Floating AI --- */
        #floating-ai-container .ai-torso { top: 60px; width: 60px; height: 65px; }
        #floating-ai-container .ai-arm { top: 70px; width: 18px; height: 45px; }
        #floating-ai-container .ai-arm-left { left: 10px; }
        #floating-ai-container .ai-arm-right { right: 10px; }
        #floating-ai-container .ai-leg { top: 115px; width: 18px; height: 40px; }
        #floating-ai-container .ai-leg-left { left: 20px; }
        #floating-ai-container .ai-leg-right { right: 20px; }
        #floating-ai-container .ai-hand { bottom: -8px; width: 24px; height: 24px; }
        #floating-ai-container .ai-foot { bottom: -8px; width: 28px; height: 16px; }
        #floating-ai-container .ai-arm::after, #floating-ai-container .ai-leg::after { top: -10px; width: 22px; height: 22px; }
        
        /* --- Sizing & Positioning for Preview AI --- */
        .preview-ai-container .ai-body { width: 90px; height: 90px; }
        .preview-ai-container .ai-torso { top: 80px; width: 90px; height: 110px; }
        .preview-ai-container .ai-arm { top: 95px; width: 25px; height: 70px; }
        .preview-ai-container .ai-arm-left { left: 20px; }
        .preview-ai-container .ai-arm-right { right: 20px; }
        .preview-ai-container .ai-leg { top: 180px; width: 25px; height: 60px; }
        .preview-ai-container .ai-leg-left { left: 40px; }
        .preview-ai-container .ai-leg-right { right: 40px; }
        .preview-ai-container .ai-hand { bottom: -15px; width: 35px; height: 35px; }
        .preview-ai-container .ai-foot { bottom: -10px; width: 40px; height: 20px; }
        .preview-ai-container .ai-arm::after, .preview-ai-container .ai-leg::after { top: -12px; width: 32px; height: 32px; }

        /* --- Animations for Limbs --- */
        .ai-arm.ai-arm-left { animation: arm-sway 2.5s ease-in-out infinite alternate; }
        .ai-arm.ai-arm-right { animation: arm-sway-right 2.5s ease-in-out infinite alternate; animation-delay: 0.2s; }
        .ai-leg.ai-leg-left { animation: leg-dangle 3.5s ease-in-out infinite alternate; }
        .ai-leg.ai-leg-right { animation: leg-dangle-right 3.5s ease-in-out infinite alternate; animation-delay: 0.3s; }
        #floating-ai-container.dragging .ai-arm, #floating-ai-container.dragging .ai-leg,
        #floating-ai-container.needy .ai-arm, #floating-ai-container.needy .ai-leg { animation: none; }

        /* Face & Expressions */
        .ai-face { width: 60%; height: 60%; position: relative; z-index: 2; }
        .ai-eye { position: absolute; top: 20%; width: 12px; height: 12px; background: var(--ai-eye-color); border-radius: 50%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); transition: all 0.2s ease; }
        .ai-eye-left { left: 15%; } .ai-eye-right { right: 15%; }
        .ai-mouth { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); width: 20px; height: 10px; border: 2px solid var(--ai-eye-color); border-top: none; border-radius: 0 0 10px 10px; transition: all 0.2s ease; }
        
        .ai-face.happy .ai-mouth { height: 15px; width: 25px; border-radius: 0 0 15px 15px; bottom: 20%; }
        .ai-face.happy .ai-eye { height: 15px; width: 8px; border-radius: 5px 5px 8px 8px; top: 15%; }
        
        .ai-face.sad .ai-mouth { transform: translateX(-50%) rotate(180deg); top: 50%; bottom: auto; border-radius: 0 0 15px 15px; }
        .ai-face.sad .ai-eye { top: 30%; }

        .ai-face.surprised .ai-eye { width: 14px; height: 14px; top: 22%; }
        .ai-face.surprised .ai-mouth { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--ai-eye-color); bottom: 20%; }

        .ai-face.wink .ai-eye-left { height: 2px; top: 28%; }
        .ai-face.wink .ai-mouth { height: 12px; width: 22px; border-radius: 0 0 12px 12px; bottom: 22%; }


        /* Guild Pass / Pricing Page */
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; justify-content: center; }
        .pricing-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 2rem; text-align:center; }
        .pricing-card.highlight { border-color: var(--color-primary); box-shadow: 0 0 30px rgba(217, 249, 157, 0.2); }
        .pricing-card ul { list-style: none; text-align: left; margin: 2rem 0; }
        .pricing-card li { margin-bottom: 1rem; }
        .pricing-card li i { margin-right: 0.5rem; }
        .pricing-card li .fa-check-circle { color: var(--color-secondary); }
        .pricing-card li .fa-star { color: gold; }
        .price-tag { font-size: 2.5rem; font-weight: 800; margin: 0.5rem 0; color: var(--color-text-heading); }
        .price-tag span { font-size: 1rem; font-weight: 500; color: var(--color-text-secondary); }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { padding: 12px 20px; border-radius: 8px; color: #fff; margin-top: 10px; opacity: 0; transform: translateY(20px); transition: all 0.4s ease; background-color: var(--color-surface-light); border: 1px solid var(--color-border); box-shadow: var(--shadow-md); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .loader-container { width: 100%; display: flex; justify-content: center; padding: 4rem; grid-column: 1 / -1; }
        .loader { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }

        .user-status { font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .user-tokens { color: var(--color-primary); font-weight: 600; display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface-light); border-radius: 6px;}
        .user-tokens .fa-coins { color: var(--color-favorite); font-size: 0.9em; }
        .card-price .fa-coins { margin-left: 0.25rem; color: var(--color-favorite); }

        /* --- Uploader Styles --- */
        #drop-zone { border: 2px dashed var(--color-border); border-radius: 8px; padding: 2.5rem; text-align: center; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; background-color: var(--color-surface); }
        #drop-zone.dragover { background-color: var(--color-surface-light); border-color: var(--color-primary); }
        #log-container { margin-top: 1.5rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 6px; padding: 1rem; height: 250px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.85em; }
        .log-entry { margin-bottom: 0.5em; }
        .log-entry.success { color: var(--color-secondary); }
        .log-entry.error { color: var(--color-error); }
        .log-entry.info { color: var(--color-text-secondary); }

        /* Responsive Design */
        @media (max-width: 992px) {
            section { padding: 60px 0; }
            .profile-content { grid-template-columns: 1fr; }
            .profile-sidebar { position: static; }
            
            .mobile-menu-toggle { display: flex; flex-direction: column; justify-content: space-around; width: 30px; height: 25px; background: transparent; border: none; cursor: pointer; z-index: 1001; }
            .mobile-menu-toggle span { width: 100%; height: 2px; background: var(--color-text-primary); border-radius: 1px; transition: all 0.3s ease; transform-origin: center; }
            .mobile-menu-toggle.active span:nth-child(1) { transform: translateY(8.5px) rotate(45deg); }
            .mobile-menu-toggle.active span:nth-child(2) { opacity: 0; }
            .mobile-menu-toggle.active span:nth-child(3) { transform: translateY(-8.5px) rotate(-45deg); }
            
            .nav-links { position: fixed; top: 0; right: -100%; height: 100vh; width: 80%; max-width: 400px; background: var(--color-surface); flex-direction: column; justify-content: center; padding: 80px 2rem; transition: right 0.4s cubic-bezier(0.23, 1, 0.32, 1); box-shadow: var(--shadow-lg); z-index: 1000; gap: 40px; }
            .nav-links.active { right: 0; }
            .nav-links a { font-size: 1.2rem; }
        }

    </style>
</head>
<body>
    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <header id="main-header">
        <div class="container">
            <nav>
                <a class="logo nav-link" data-target="hero-page"><i class="fa-solid fa-bolt"></i> Anvil</a>
                <ul class="nav-links">
                    <li><a class="nav-link" data-target="features-showcase">Customizer</a></li>
                    <li><a class="nav-link" data-target="marketplace-page">Marketplace</a></li>
                    <li><a class="nav-link" data-target="guildpass-page">Guild Pass</a></li>
                    <li><a class="nav-link" data-target="token-shop-page">Token Shop</a></li>
                    <li><a class="nav-link hidden" data-target="inventory-page" id="inventory-nav-link">My Inventory</a></li>
                    <li><a class="nav-link hidden" data-target="profile-page" id="profile-nav-link">Profile</a></li>
                    <li><a class="nav-link hidden" data-target="uploader-page" id="upload-nav-link">Upload Item</a></li>
                </ul>
                <div class="auth-container">
                    <div class="user-status" id="user-status-container"></div>
                    <a href="#" id="auth-button" class="btn btn-secondary">Login</a>
                </div>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu"><span></span><span></span><span></span></button>
            </nav>
        </div>
    </header>

    <main>
        <section id="hero-page">
             <div class="container">
                <div class="hero-content" data-aos="fade-up">
                    <h1>Your Personal <span class="text-gradient">AI Companion</span>, Forged by You.</h1>
                    <p class="subtitle">Anvil is a powerful desktop application that lets you build, customize, and interact with a truly personal AI. Go beyond assistants—create a personality.</p>
                    <a href="https://buy.stripe.com/3cI3cv32w7aM3qbaUA" target="_blank" class="btn btn-primary pulse-button">Get Anvil - $99.99</a>
                </div>
            </div>
        </section>

        <section id="features-showcase" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>AI <span class="text-gradient">Customizer</span></h2>
                    <p>Modify your AI's appearance in real-time. Changes are saved to your account when you log in.</p>
                </div>
                <div class="customizer-layout">
                    <div class="customizer-preview" data-aos="fade-right">
                        <div class="preview-ai-container">
                             <div class="ai-character-rig">
                                <div class="ai-body">
                                    <div id="preview-skin-layer" class="ai-skin-layer"></div>
                                    <div class="ai-face">
                                        <div class="ai-eye ai-eye-left"></div>
                                        <div class="ai-eye ai-eye-right"></div>
                                        <div class="ai-mouth"></div>
                                    </div>
                                </div>
                                <div class="ai-torso"></div>
                                <div class="ai-arm ai-arm-left"><div class="ai-hand"></div></div>
                                <div class="ai-arm ai-arm-right"><div class="ai-hand"></div></div>
                                <div class="ai-leg ai-leg-left"><div class="ai-foot"></div></div>
                                <div class="ai-leg ai-leg-right"><div class="ai-foot"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="customizer-controls" data-aos="fade-left">
                        <div class="control-group">
                            <label for="ai-body-color-picker">Body Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="ai-body-color-picker" value="#d9f99d">
                                <span id="ai-body-color-value" class="color-value">#d9f99d</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="ai-eye-color-picker">Eye & Mouth Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" id="ai-eye-color-picker" value="#010409">
                                <span id="ai-eye-color-value" class="color-value">#010409</span>
                            </div>
                        </div>
                        <button id="save-customizations-btn" class="btn btn-primary">Save Appearance</button>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="marketplace-page" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>The <span class="text-gradient">Marketplace</span></h2>
                    <p>Use your Fugth Tokens to acquire unique personalities, skins, and tools for your AI.</p>
                </div>
                <div id="category-filters-container" data-aos="fade-up" data-aos-delay="100">
                    <div class="category-filters" id="category-filters">
                    </div>
                </div>
                <div class="page-content"><div class="grid-container" id="market-grid-container"></div></div>
            </div>
        </section>

        <section id="guildpass-page" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>Anvil <span class="text-gradient">Guild Pass</span></h2>
                    <p>Choose your path: get the core application or subscribe to the Guild Pass for the ultimate experience.</p>
                </div>
                <div class="pricing-grid" data-aos="fade-up">
                    <div class="pricing-card">
                        <h3>Anvil App</h3>
                        <p class="text-gradient" style="font-weight: 600;">One-Time Purchase</p>
                        <p class="price-tag">$99.99</p>
                        <ul>
                            <li><i class="fas fa-check-circle"></i> Lifetime access to the Anvil desktop app.</li>
                            <li><i class="fas fa-check-circle"></i> Full personality forging and customization tools.</li>
                            <li><i class="fas fa-check-circle"></i> Access to the community marketplace.</li>
                        </ul>
                        <a href="https://buy.stripe.com/3cI3cv32w7aM3qbaUA" target="_blank" class="btn btn-secondary" style="width:100%;">Purchase Anvil</a>
                    </div>
                    <div class="pricing-card highlight">
                        <h3>Guild Pass</h3>
                        <p class="text-gradient" style="font-weight: 600;">Monthly Subscription</p>
                        <p class="price-tag">$7.99<span>/mo</span></p>
                         <ul>
                            <li><i class="fas fa-star"></i> <strong>777</strong> Fugth Tokens delivered every month.</li>
                            <li><i class="fas fa-star"></i> Exclusive skins and personalities for subscribers.</li>
                            <li><i class="fas fa-star"></i> Early access to new features and AI models.</li>
                            <li><i class="fas fa-star"></i> Special role in the community Discord.</li>
                        </ul>
                        <a href="https://buy.stripe.com/8x228rbz23YA9OzbYE" target="_blank" class="btn btn-primary" style="width:100%;">Subscribe Now</a>
                        <p style="font-size: 0.8rem; margin-top: 1rem; color: var(--color-text-secondary);">Requires purchase of the Anvil App.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="token-shop-page" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>Fugth <span class="text-gradient">Token Shop</span></h2>
                    <p>Purchase Fugth Tokens to acquire items from the marketplace and customize your AI companion.</p>
                </div>
                <div class="grid-container" data-aos="fade-up">
                     <div class="market-card">
                         <div class="card-image"><i class="fas fa-coins"></i></div>
                         <div class="card-content" style="text-align:center;">
                             <h4 class="card-title">100 Fugth Tokens</h4>
                             <p class="card-creator">A small pack to get you started.</p>
                         </div>
                         <div class="card-footer"><a href="https://buy.stripe.com/6oUdR90Uobr2d0L2o4" target="_blank" class="btn btn-primary" style="width:100%;">$0.99</a></div>
                    </div>
                     <div class="market-card">
                        <div class="card-image" style="font-size: 4rem;"><i class="fas fa-layer-group"></i></div>
                        <div class="card-content" style="text-align:center;">
                           <h4 class="card-title">550 Fugth Tokens</h4>
                           <p class="card-creator">Best value pack with a 10% bonus!</p>
                       </div>
                        <div class="card-footer"><a href="https://buy.stripe.com/fZu6oHgTmeDe6Cn3s8" target="_blank" class="btn btn-primary" style="width:100%;">$4.99</a></div>
                    </div>
                    <div class="market-card">
                        <div class="card-image" style="font-size: 5rem;"><i class="fas fa-gem"></i></div>
                        <div class="card-content" style="text-align:center;">
                           <h4 class="card-title">1200 Fugth Tokens</h4>
                           <p class="card-creator">The ultimate pack with a 20% bonus!</p>
                       </div>
                        <div class="card-footer"><a href="https://buy.stripe.com/28E5kDdHa2Uw2m78Ms" target="_blank" class="btn btn-primary" style="width:100%;">$9.99</a></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="inventory-page" class="hidden">
             <div class="container">
                   <div class="section-header" data-aos="fade-up">
                        <h2>My <span class="text-gradient">Inventory</span></h2>
                        <p>All of your acquired items in one place. Equip skins and accessories to customize your AI's appearance.</p>
               </div>
                <div id="inventory-category-filters-container" data-aos="fade-up" data-aos-delay="100">
                    <div class="category-filters" id="inventory-category-filters"></div>
                </div>
                <div class="page-content"><div class="grid-container" id="inventory-grid-container"></div></div>
             </div>
        </section>
        
        <section id="profile-page" class="hidden">
            <div class="container">
                <div class="profile-content" data-aos="fade-up">
                    <div class="profile-sidebar">
                            <div id="profile-avatar-wrapper"></div>
                            <button class="avatar-change-btn" title="Change Avatar" id="avatarChangeBtn"><i class="fas fa-user-edit"></i></button>
                            <h3 id="profileDisplayName">User Name</h3>
                            <p id="profileEmail">user@example.com</p>
                        <div class="profile-stats">
                            <div class="stat-item"><div class="stat-value" id="totalTokens">0</div><div class="stat-label">Fugth Tokens</div></div>
                            <div class="stat-item"><div class="stat-value" id="joinDate">-</div><div class="stat-label">Joined</div></div>
                        </div>
                    </div>
                    <div class="profile-main">
                        <div class="profile-section">
                            <h3>Personal Information</h3>
                            <form id="personalInfoForm">
                                <div class="form-group">
                                    <label for="displayName">Display Name</label>
                                    <input type="text" id="displayName" name="displayName" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" name="email" disabled>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="uploader-page" class="hidden">
            <div class="container" style="max-width: 700px;">
                <div class="section-header" data-aos="fade-up">
                    <h2>Admin <span class="text-gradient">Uploader</span></h2>
                    <p>Upload new marketplace items from a .json or .txt file.</p>
                </div>
                <div id="uploader-main-content" data-aos="fade-up">
                    <label for="file-input" id="drop-zone">
                        <p>Drag & Drop your .json or .txt file here</p>
                        <p style="font-size: 0.8em; color: var(--color-text-secondary);">or click to select a file</p>
                    </label>
                    <input type="file" id="file-input" accept=".json,.txt" style="display: none;">
                    <div id="file-info" style="text-align: center; margin: 1rem 0; color: var(--color-text-secondary);">No file selected</div>
                    <button id="upload-btn" class="btn btn-primary" style="width:100%;" disabled>Upload to Firestore</button>
                    <div id="log-container">
                        <div class="log-entry info">> Awaiting file...</div>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <div id="floating-ai-container">
        <div class="ai-character-rig">
             <div class="ai-body">
                <div class="ai-skin-layer"></div>
                <div class="ai-face">
                    <div class="ai-eye ai-eye-left"></div>
                    <div class="ai-eye ai-eye-right"></div>
                    <div class="ai-mouth"></div>
                </div>
            </div>
            <div class="ai-torso"></div>
            <div class="ai-arm ai-arm-left"><div class="ai-hand"></div></div>
            <div class="ai-arm ai-arm-right"><div class="ai-hand"></div></div>
            <div class="ai-leg ai-leg-left"><div class="ai-foot"></div></div>
            <div class="ai-leg ai-leg-right"><div class="ai-foot"></div></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
    'use strict';
    
    const App = {
        // --- STATE MANAGEMENT ---
        state: {
            currentUser: null,
            userData: {},
            userInventory: new Map(),
            allProductsCache: new Map(),
            equippedItems: { skin: null, bodyColor: '#d9f99d', eyeColor: '#010409' },
            currentCategory: 'all',
            currentInventoryCategory: 'all',
        },

        // --- DOM ELEMENTS CACHE ---
        elements: {},

        // --- FLOATING AI LOGIC ---
        floatingAI: {
            isDragging: false, isNeedy: false, offsetX: 0, offsetY: 0, moveTimeout: null, inactivityTimer: null,
            needyAnimationId: null, lastInteractionTime: Date.now(), mouse: { x: window.innerWidth / 2, y: window.innerHeight / 2 },
            expressions: ['neutral', 'wink', 'happy', 'surprised'],
            expressionTimer: null,
            init() {
                const aiContainer = App.elements.aiContainer;
                aiContainer.addEventListener('mousedown', this.startDrag.bind(this));
                document.addEventListener('mousemove', this.updateMousePosition.bind(this));
                document.addEventListener('click', this.resetInteractionTimer.bind(this));
                aiContainer.addEventListener('dblclick', this.handleHappyRunOff.bind(this));
                aiContainer.style.top = `${window.innerHeight / 2}px`;
                aiContainer.style.left = `${window.innerWidth / 2}px`;
                this.startInactivityCheck();
                this.scheduleNextMove();
                this.changeExpressionRandomly();
            },
            updateMousePosition(e) { this.mouse.x = e.clientX; this.mouse.y = e.clientY; this.resetInteractionTimer(); },
            setFace(face) {
                const aiFaceEl = App.elements.aiContainer.querySelector('.ai-face');
                if (aiFaceEl) { aiFaceEl.className = 'ai-face'; if (face && face !== 'neutral') aiFaceEl.classList.add(face); }
            },
            changeExpressionRandomly() {
                if (this.isNeedy || this.isDragging) return;
                const currentFace = App.elements.aiContainer.querySelector('.ai-face').classList[1] || 'neutral';
                let possibleExpressions = this.expressions.filter(e => e !== currentFace);
                if (possibleExpressions.length === 0) possibleExpressions = ['neutral'];
                const randomExpression = possibleExpressions[Math.floor(Math.random() * possibleExpressions.length)];
                this.setFace(randomExpression);

                if(this.expressionTimer) clearTimeout(this.expressionTimer);
                this.expressionTimer = setTimeout(this.changeExpressionRandomly.bind(this), Math.random() * 4000 + 2000);
            },
            startDrag(e) {
                if (this.isNeedy) return; 
                this.isDragging = true; 
                clearTimeout(this.expressionTimer);
                const aiContainer = App.elements.aiContainer;
                aiContainer.classList.add('dragging'); clearTimeout(this.moveTimeout); this.offsetX = e.clientX - aiContainer.offsetLeft;
                this.offsetY = e.clientY - aiContainer.offsetTop;
                const dragMove = (e) => { if (!this.isDragging) return; aiContainer.style.left = `${e.clientX - this.offsetX}px`; aiContainer.style.top = `${e.clientY - this.offsetY}px`; };
                const dragEnd = () => { 
                    this.isDragging = false; 
                    aiContainer.classList.remove('dragging'); 
                    this.scheduleNextMove(); 
                    this.changeExpressionRandomly();
                    document.removeEventListener('mousemove', dragMove); 
                    document.removeEventListener('mouseup', dragEnd); 
                };
                document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', dragEnd, { once: true });
            },
            resetInteractionTimer() { this.lastInteractionTime = Date.now(); },
            startInactivityCheck() { if (this.inactivityTimer) clearInterval(this.inactivityTimer); this.inactivityTimer = setInterval(() => { if (Date.now() - this.lastInteractionTime > 30000 && !this.isNeedy && !this.isDragging) { this.enterNeedyMode(); } }, 2000); },
            enterNeedyMode() {
                this.isNeedy = true; 
                clearTimeout(this.moveTimeout);
                clearTimeout(this.expressionTimer);
                App.elements.aiContainer.classList.add('needy'); this.setFace('sad');
                const followCursor = () => { if (!this.isNeedy) return; const rect = App.elements.aiContainer.getBoundingClientRect(); const targetX = this.mouse.x - rect.width / 2; const targetY = this.mouse.y - rect.height / 2; const currentX = rect.left; const currentY = rect.top; App.elements.aiContainer.style.left = `${currentX + (targetX - currentX) * 0.08}px`; App.elements.aiContainer.style.top = `${currentY + (targetY - currentY) * 0.08}px`; this.needyAnimationId = requestAnimationFrame(followCursor); };
                this.needyAnimationId = requestAnimationFrame(followCursor);
            },
            stopNeedyMode() { if (!this.isNeedy) return; this.isNeedy = false; cancelAnimationFrame(this.needyAnimationId); App.elements.aiContainer.classList.remove('needy'); this.resetInteractionTimer(); },
            handleHappyRunOff() { 
                if (!this.isNeedy) return; 
                this.stopNeedyMode(); 
                this.setFace('happy'); 
                App.elements.aiContainer.classList.add('running-off'); 
                setTimeout(() => { 
                    App.elements.aiContainer.classList.remove('running-off'); 
                    this.moveAiRandomly(true); 
                    setTimeout(() => {
                        this.setFace('neutral');
                        this.changeExpressionRandomly();
                    }, 1000); 
                }, 700); 
            },
            moveAiRandomly(immediate = false) { if (this.isDragging || this.isNeedy) return; const aiContainer = App.elements.aiContainer; const maxX = window.innerWidth - aiContainer.clientWidth; const maxY = window.innerHeight - aiContainer.clientHeight; aiContainer.style.left = `${Math.random() * maxX}px`; aiContainer.style.top = `${Math.random() * maxY}px`; this.scheduleNextMove(); },
            scheduleNextMove() { clearTimeout(this.moveTimeout); if (this.isNeedy || this.isDragging) return; this.moveTimeout = setTimeout(() => this.moveAiRandomly(false), 8000); }
        },

        // --- UI MANIPULATION ---
        ui: {
            init() { AOS.init({ duration: 800, once: true, offset: 50 }); },
            applyAIVisuals() {
                const { equippedItems, allProductsCache } = App.state;
                
                // Apply colors
                document.documentElement.style.setProperty('--ai-body-color', equippedItems.bodyColor || '#d9f99d');
                document.documentElement.style.setProperty('--ai-eye-color', equippedItems.eyeColor || '#010409');

                // Apply skin icon
                const skinProduct = equippedItems.skin ? allProductsCache.get(equippedItems.skin) : null;
                const iconClass = skinProduct ? skinProduct.icon : null;
                
                const skinLayers = document.querySelectorAll('.ai-skin-layer');
                skinLayers.forEach(layer => {
                    if (layer) {
                        layer.innerHTML = '';
                        layer.classList.remove('icon-active');
                        if (iconClass) {
                            layer.innerHTML = `<i class="fa-solid fa-${iconClass}"></i>`;
                            layer.classList.add('icon-active');
                        }
                    }
                });
            },
            updateAllVisuals() { 
                this.applyAIVisuals();
                this.updateAvatarDisplay();
            },
            switchToPage(pageId) { document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden')); const targetPage = document.getElementById(pageId); if (targetPage) { targetPage.classList.remove('hidden'); AOS.refresh(); } App.elements.navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === pageId)); window.scrollTo(0, 0); },
            updateNavForLoggedInUser() {
                App.elements.authButton.textContent = 'Logout'; App.elements.inventoryNavLink.classList.remove('hidden');
                App.elements.profileNavLink.classList.remove('hidden'); this.updateAvatarDisplay();
                if (App.state.userData.role === 'admin') { App.elements.uploadNavLink.classList.remove('hidden'); }
            },
            updateUIForLoggedOutUser() {
                App.elements.userStatusContainer.innerHTML = ''; App.elements.authButton.textContent = 'Login';
                App.elements.inventoryNavLink.classList.add('hidden'); App.elements.profileNavLink.classList.add('hidden');
                App.elements.uploadNavLink.classList.add('hidden');
                // Reset to default visuals on logout
                App.state.equippedItems = { skin: null, bodyColor: '#d9f99d', eyeColor: '#010409' };
                this.updateAllVisuals();
                this.updateCustomizerControls();
                this.switchToPage('hero-page');
            },
            updateAvatarDisplay() {
                const { currentUser, userData, equippedItems, allProductsCache } = App.state; if (!currentUser) return;
                const name = userData.displayName || currentUser.email.split('@')[0]; const tokenBalance = userData.tokens || 0;
                let avatarBaseHtml = `<div class="avatar-base"><i class="fas fa-user"></i></div>`;
                const skinId = equippedItems.skin;
                if (skinId && allProductsCache.has(skinId)) { const skinProduct = allProductsCache.get(skinId); avatarBaseHtml = `<div class="avatar-base"><i class="fa-solid fa-${skinProduct.icon}"></i></div>`; }
                App.elements.userStatusContainer.innerHTML = `<div class="user-tokens"><span>${tokenBalance}</span> <i class="fas fa-coins"></i></div><div class="avatar-display">${avatarBaseHtml}</div><span>${name}</span>`;
                if (document.getElementById('profile-avatar-wrapper')) { document.getElementById('profile-avatar-wrapper').innerHTML = `<div class="avatar-display">${avatarBaseHtml}</div>`; }
            },
            updateProfilePageUI() {
                const { currentUser, userData } = App.state; if (!currentUser || !userData) return;
                this.updateAvatarDisplay(); document.getElementById('profileDisplayName').textContent = userData.displayName;
                document.getElementById('profileEmail').textContent = userData.email; document.getElementById('displayName').value = userData.displayName;
                document.getElementById('email').value = userData.email; document.getElementById('totalTokens').textContent = userData.tokens || 0;
                const joinDate = userData.createdAt?.toDate(); if (joinDate) document.getElementById('joinDate').textContent = joinDate.toLocaleDateString();
            },
            updateCustomizerControls() {
                const { bodyColor, eyeColor } = App.state.equippedItems;
                App.elements.bodyColorPicker.value = bodyColor;
                App.elements.bodyColorValue.textContent = bodyColor;
                App.elements.eyeColorPicker.value = eyeColor;
                App.elements.eyeColorValue.textContent = eyeColor;
            },
            renderCategoryFilters() {
                const categories = ['all', ...new Set(Array.from(App.state.allProductsCache.values()).map(p => p.category).filter(Boolean))];
                App.elements.categoryFilters.innerHTML = categories.map(cat => `<button class="btn btn-secondary ${App.state.currentCategory === cat ? 'active' : ''}" data-category="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>`).join('');
            },
            renderMarketplace() {
                let products = Array.from(App.state.allProductsCache.values());
                if (App.state.currentCategory !== 'all') { products = products.filter(p => p.category === App.state.currentCategory); }
                App.elements.marketGrid.innerHTML = products.length ? products.map(p => this.createProductCard(p, 'marketplace')).join('') : `<p style='text-align: center; grid-column: 1 / -1;'>No items found in this category.</p>`;
                setTimeout(() => AOS.refresh(), 100);
            },
            renderInventoryCategoryFilters() {
                if (!App.state.currentUser) return;
                const ownedItems = Array.from(App.state.userInventory.keys()).map(id => App.state.allProductsCache.get(id)).filter(Boolean);
                const categories = ['all', ...new Set(ownedItems.map(p => p.category).filter(Boolean))];
                App.elements.inventoryCategoryFilters.innerHTML = categories.map(cat => `<button class="btn btn-secondary ${App.state.currentInventoryCategory === cat ? 'active' : ''}" data-category="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>`).join('');
            },
            renderInventory() {
                this.renderInventoryCategoryFilters();
                if (App.state.userInventory.size === 0) { App.elements.inventoryGrid.innerHTML = "<p style='text-align: center; grid-column: 1 / -1;'>Your inventory is empty. Visit the marketplace!</p>"; return; }
                
                let inventoryArray = Array.from(App.state.userInventory.keys()).map(id => App.state.allProductsCache.get(id)).filter(item => item && item.name);
                
                if (App.state.currentInventoryCategory !== 'all') {
                    inventoryArray = inventoryArray.filter(p => p.category === App.state.currentInventoryCategory);
                }

                App.elements.inventoryGrid.innerHTML = inventoryArray.length 
                    ? inventoryArray.map(product => this.createProductCard(product, 'inventory')).join('')
                    : "<p style='text-align: center; grid-column: 1 / -1;'>No items found in this category.</p>";
            },
            createProductCard(product, context) {
                if (!product) return '';
                const { userInventory, equippedItems } = App.state;
                const isOwned = userInventory.has(product.id);
                const isEquipped = equippedItems.skin === product.id;
                let footerHtml = '';

                if (context === 'inventory') {
                    if (product.category === 'skin') {
                        footerHtml = `<button class="btn btn-primary equip-btn" data-product-id="${product.id}">${isEquipped ? 'Unequip' : 'Equip'}</button>`;
                    } else if (product.category === 'tool' && product.id === 'GGtZEFfqGAZNvkmajH5c') {
                        const downloadUrl = 'https://github.com/FugthChat/FugthDesignSpace/releases/download/v1.0.0-anvilbeta/FugthAnvil.exe';
                        footerHtml = `<a href="${downloadUrl}" class="btn btn-primary" style="background-color: var(--color-secondary); border-color: var(--color-secondary);">Install Anvil</a>`;
                    } else {
                        footerHtml = `<button class="btn btn-secondary" disabled>Cannot Use Here</button>`;
                    }
                } else { // Marketplace context
                    const priceText = product.price === 0 ? 'Free' : `${product.price} <i class="fas fa-coins"></i>`;
                    const actionButton = isOwned ? `<button class="btn" disabled>Owned</button>` : `<button class="btn btn-primary purchase-btn" data-product-id="${product.id}">Get</button>`;
                    footerHtml = `<span class="card-price text-gradient">${priceText}</span>${actionButton}`;
                }
                return `<div class="market-card ${isEquipped ? 'equipped' : ''}" data-product-id="${product.id}" data-aos="fade-up">
                            <div class="card-image"><i class="fa-solid fa-${product.icon}"></i></div>
                            <div class="card-content">
                                <h4 class="card-title">${product.name}</h4>
                                <p class="card-creator">by ${product.creator}</p>
                                <p class="card-description">${product.description || 'No description available.'}</p>
                            </div>
                            <div class="card-footer">${footerHtml}</div>
                        </div>`;
            },
            openAuthModal(showSignup = false) {
                const loginHidden = showSignup ? 'hidden' : ''; const signupHidden = !showSignup ? 'hidden' : '';
                App.elements.modalContainer.innerHTML = `<div class="modal-content">
                    <div class="modal-close"><i class="fa-solid fa-times"></i></div>
                    <div class="modal-body">
                        <div id="login-view" class="${loginHidden}"><h3>Login</h3><form id="login-form" class="auth-form"><p class="form-error" style="color:var(--color-error); text-align:center;"></p><input type="email" name="email" placeholder="Email" required><input type="password" name="password" placeholder="Password" required><button type="submit" class="btn btn-primary" style="width:100%;">Login</button></form><p style="text-align:center; margin-top:1rem;">No account? <a href="#" id="show-signup" style="color:var(--color-primary)">Sign Up</a></p></div>
                        <div id="signup-view" class="${signupHidden}"><h3>Create Account</h3><form id="signup-form" class="auth-form"><p class="form-error" style="color:var(--color-error); text-align:center;"></p><input type="email" name="email" placeholder="Email" required><input type="password" name="password" placeholder="Password" required><button type="submit" class="btn btn-primary" style="width:100%;">Create</button></form><p style="text-align:center; margin-top:1rem;">Have an account? <a href="#" id="show-login" style="color:var(--color-primary)">Login</a></p></div>
                    </div>
                </div>`;
                if (App.elements.modalContainer.classList.contains('closing')) { App.elements.modalContainer.classList.remove('closing'); }
                App.elements.modalContainer.classList.add('show');
            },
            openProductDetailsModal(product) {
                if (!product) return;
                const { userInventory, equippedItems } = App.state;
                const isOwned = userInventory.has(product.id);
                const isEquipped = equippedItems.skin === product.id;
                let footerHtml = '';
                
                if (isOwned) {
                    if (product.category === 'skin') {
                         footerHtml = `<button class="btn btn-primary equip-btn" data-product-id="${product.id}">${isEquipped ? 'Unequip' : 'Equip'}</button>`;
                    } else if (product.category === 'tool' && product.id === 'GGtZEFfqGAZNvkmajH5c') {
                        const downloadUrl = 'https://github.com/FugthChat/FugthDesignSpace/releases/download/v1.0.0-anvilbeta/FugthAnvil.exe';
                        footerHtml = `<a href="${downloadUrl}" class="btn btn-primary" style="background-color: var(--color-secondary); border-color: var(--color-secondary);">Install Anvil</a>`;
                    } else {
                        footerHtml = `<button class="btn" disabled>Owned</button>`;
                    }
                } else {
                    const priceText = product.price === 0 ? 'Free' : `${product.price} <i class="fas fa-coins"></i>`;
                    footerHtml = `<span class="card-price text-gradient">${priceText}</span><button class="btn btn-primary purchase-btn" data-product-id="${product.id}">Get</button>`;
                }

                App.elements.modalContainer.innerHTML = `<div class="modal-content">
                    <div class="modal-close"><i class="fa-solid fa-times"></i></div>
                    <div class="modal-header">
                         <div class="item-details-icon"><i class="fa-solid fa-${product.icon}"></i></div>
                         <h3 style="text-align:center;">${product.name}</h3>
                         <p style="text-align:center; margin-bottom: 0;">by ${product.creator} | v${product.version}</p>
                    </div>
                    <div class="modal-body">
                        <p>${product.details || product.description}</p>
                        <div class="item-details-tags">
                            ${(product.tags || []).map(tag => `<span class="item-details-tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="modal-footer" id="details-modal-footer">
                        ${footerHtml}
                    </div>
                </div>`;

                if (App.elements.modalContainer.classList.contains('closing')) { App.elements.modalContainer.classList.remove('closing'); }
                App.elements.modalContainer.classList.add('show');
            },
            closeModal() {
                 if (App.elements.modalContainer && App.elements.modalContainer.classList.contains('show')) {
                        App.elements.modalContainer.classList.add('closing');
                        setTimeout(() => {
                            App.elements.modalContainer.classList.remove('show');
                            App.elements.modalContainer.classList.remove('closing');
                            App.elements.modalContainer.innerHTML = '';
                        }, 400);
                 }
            },
            showToast(message) {
                const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3000);
            }
        },

        // --- UPLOADER LOGIC ---
        uploader: {
            /* ... Omitted for brevity, no changes needed ... */
        },

        // --- FIREBASE & DATA LOGIC ---
        firebase: {
            auth: null, db: null,
            init() { const firebaseConfig = { apiKey: "AIzaSyBlqTqN1gUoCpuqPqmpLdtZdJHVFbTWyTs", authDomain: "fugthdesign-91744.firebaseapp.com", projectId: "fugthdesign-91744", storageBucket: "fugthdesign-91744.appspot.com", messagingSenderId: "797596632132", appId: "1:797596632132:web:2c2ebfa54c908e09a26811" }; firebase.initializeApp(firebaseConfig); this.auth = firebase.auth(); this.db = firebase.firestore(); },
            async handleAuthStateChange(user) { App.state.currentUser = user; if (user) await this.onLogin(); else App.ui.updateUIForLoggedOutUser(); },
            async onLogin() { 
                await this.fetchUserData(); 
                await Promise.all([this.fetchEquippedItems(), this.fetchUserInventory(), this.checkForDailyLogin()]); 
                App.ui.updateNavForLoggedInUser(); 
                App.ui.updateAllVisuals();
                App.ui.updateProfilePageUI(); 
                App.ui.renderMarketplace();
                App.ui.updateCustomizerControls();
            },
            async fetchUserData() {
                const userRef = this.db.collection('users').doc(App.state.currentUser.uid); const roleRef = this.db.collection('roles').doc(App.state.currentUser.uid);
                const [userDoc, roleDoc] = await Promise.all([userRef.get(), roleRef.get()]);
                if (userDoc.exists) { App.state.userData = userDoc.data(); } else { const initialData = { displayName: App.state.currentUser.displayName || App.state.currentUser.email.split('@')[0], email: App.state.currentUser.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tokens: 50, lastLogin: new Date() }; await userRef.set(initialData); App.state.userData = initialData; }
                if (roleDoc.exists && roleDoc.data().role) { App.state.userData.role = roleDoc.data().role; } else { App.state.userData.role = 'user'; }
            },
            async checkForDailyLogin() {
                const today = new Date().toISOString().split('T')[0]; const lastLoginDate = App.state.userData.lastLogin?.toDate().toISOString().split('T')[0];
                if (today !== lastLoginDate) { const newTokens = (App.state.userData.tokens || 0) + 7; await this.db.collection('users').doc(App.state.currentUser.uid).update({ tokens: newTokens, lastLogin: new Date() }); App.state.userData.tokens = newTokens; App.ui.showToast(`+7 Tokens for your daily login!`); }
            },
            async fetchAllProducts() { const snapshot = await this.db.collection('products').get(); App.state.allProductsCache.clear(); snapshot.forEach(doc => App.state.allProductsCache.set(doc.id, { id: doc.id, ...doc.data() })); },
            async fetchUserInventory() { if (!App.state.currentUser) return; App.state.userInventory.clear(); const snapshot = await this.db.collection('user_inventory').doc(App.state.currentUser.uid).collection('items').get(); snapshot.forEach(doc => App.state.userInventory.set(doc.id, doc.data())); },
            async fetchEquippedItems() { 
                if (!App.state.currentUser) { 
                    App.state.equippedItems = { skin: null, bodyColor: '#d9f99d', eyeColor: '#010409' }; 
                    return; 
                } 
                const doc = await this.db.collection('users').doc(App.state.currentUser.uid).collection('settings').doc('avatar').get(); 
                if (doc.exists) {
                    const data = doc.data();
                    App.state.equippedItems = { 
                        skin: data.skin || null,
                        bodyColor: data.bodyColor || '#d9f99d',
                        eyeColor: data.eyeColor || '#010409'
                    };
                } else {
                    App.state.equippedItems = { skin: null, bodyColor: '#d9f99d', eyeColor: '#010409' };
                }
            },
        },

        // --- EVENT HANDLERS ---
        handlers: {
            async handleLogin(e) { e.preventDefault(); const loginButton = e.target.querySelector('button[type="submit"]'); loginButton.disabled = true; loginButton.innerHTML = `<span class="loader" style="width:1.2rem;height:1.2rem;border-width:2px;margin:auto;"></span>`; try { await App.firebase.auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value); App.ui.showToast(`Welcome back!`); App.ui.closeModal(); } catch (err) { e.target.querySelector('.form-error').textContent = err.message; loginButton.disabled = false; loginButton.innerHTML = 'Login'; } },
            async handleSignup(e) { e.preventDefault(); const signupButton = e.target.querySelector('button[type="submit"]'); signupButton.disabled = true; signupButton.innerHTML = `<span class="loader" style="width:1.2rem;height:1.2rem;border-width:2px;margin:auto;"></span>`; try { const cred = await App.firebase.auth.createUserWithEmailAndPassword(e.target.email.value, e.target.password.value); const initialName = cred.user.email.split('@')[0]; await cred.user.updateProfile({ displayName: initialName }); await App.firebase.db.collection('users').doc(cred.user.uid).set({ displayName: initialName, email: cred.user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tokens: 50, lastLogin: new Date() }); App.ui.showToast(`Welcome! You start with 50 Fugth Tokens!`); App.ui.closeModal(); } catch (err) { e.target.querySelector('.form-error').textContent = err.message; signupButton.disabled = false; signupButton.innerHTML = 'Create'; } },
            async handleEquipToggle(productId) { if (!App.state.currentUser) return; const newSkin = App.state.equippedItems.skin === productId ? null : productId; try { await App.firebase.db.collection('users').doc(App.state.currentUser.uid).collection('settings').doc('avatar').set({ skin: newSkin }, { merge: true }); App.state.equippedItems.skin = newSkin; App.ui.updateAllVisuals(); App.ui.renderInventory(); App.ui.showToast(`Item ${newSkin ? 'equipped' : 'unequipped'}.`); App.ui.closeModal(); } catch (error) { App.ui.showToast("Couldn't save your choice."); } },
            async handleProfileUpdate(e) { /* ... Omitted for brevity, no changes ... */ },
            async handlePurchase(productId) { /* ... Omitted for brevity, no changes ... */ },
            async handleAvatarCustomizationSave() {
                if (!App.state.currentUser) {
                    App.ui.showToast("Please log in to save your customizations.");
                    return;
                }
                const btn = App.elements.saveCustomizationsBtn;
                btn.disabled = true;
                btn.textContent = 'Saving...';

                const newColors = {
                    bodyColor: App.elements.bodyColorPicker.value,
                    eyeColor: App.elements.eyeColorPicker.value
                };

                try {
                    await App.firebase.db.collection('users').doc(App.state.currentUser.uid).collection('settings').doc('avatar').set(newColors, { merge: true });
                    App.state.equippedItems.bodyColor = newColors.bodyColor;
                    App.state.equippedItems.eyeColor = newColors.eyeColor;
                    App.ui.showToast("Appearance saved!");
                } catch (error) {
                    App.ui.showToast("Error saving appearance.");
                    console.error("Error saving customizations: ", error);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Save Appearance';
                }
            }
        },

        // --- EVENT LISTENER SETUP ---
        bindEvents() {
            App.elements.navLinks.forEach(link => link.addEventListener('click', (e) => {
                e.preventDefault(); const targetId = e.currentTarget.dataset.target;
                if ((targetId.includes('inventory') || targetId.includes('profile') || targetId.includes('uploader')) && !App.state.currentUser) { App.ui.openAuthModal(); return; }
                if (targetId === 'inventory-page') { App.state.currentInventoryCategory = 'all'; App.ui.renderInventory(); }
                App.ui.switchToPage(targetId); App.elements.navLinksContainer.classList.remove('active'); App.elements.mobileMenuToggle.classList.remove('active');
            }));

            window.addEventListener('scroll', () => App.elements.header.classList.toggle('scrolled', window.scrollY > 50));
            App.elements.authButton.addEventListener('click', e => { e.preventDefault(); App.state.currentUser ? App.firebase.auth.signOut() : App.ui.openAuthModal(); });

            document.addEventListener('click', e => {
                const equipBtn = e.target.closest('.equip-btn');
                const purchaseBtn = e.target.closest('.purchase-btn');
                if (equipBtn) return App.handlers.handleEquipToggle(equipBtn.dataset.productId);
                if (purchaseBtn) return App.handlers.handlePurchase(purchaseBtn.dataset.productId);
                
                const card = e.target.closest('.market-card');
                const cardFooter = e.target.closest('.card-footer');
                if (card && !cardFooter) {
                    const product = App.state.allProductsCache.get(card.dataset.productId);
                    App.ui.openProductDetailsModal(product);
                }
            });

            App.elements.personalInfoForm?.addEventListener('submit', App.handlers.handleProfileUpdate);
            App.elements.mobileMenuToggle.addEventListener('click', () => { App.elements.mobileMenuToggle.classList.toggle('active'); App.elements.navLinksContainer.classList.toggle('active'); });
            
            App.elements.modalContainer.addEventListener('click', (e) => {
                if (e.target.closest('.modal-close') || e.target.id === 'modal-container') App.ui.closeModal();
                else if (e.target.closest('#show-signup')) { e.preventDefault(); App.ui.openAuthModal(true); }
                else if (e.target.closest('#show-login')) { e.preventDefault(); App.ui.openAuthModal(false); }
            });
            
            App.elements.modalContainer.addEventListener('submit', (e) => { if(e.target.id === 'login-form') App.handlers.handleLogin(e); if(e.target.id === 'signup-form') App.handlers.handleSignup(e); });
            App.elements.categoryFilters.addEventListener('click', e => { if (e.target.matches('.btn[data-category]')) { App.state.currentCategory = e.target.dataset.category; App.ui.renderCategoryFilters(); App.ui.renderMarketplace(); } });
            App.elements.inventoryCategoryFilters.addEventListener('click', e => { if (e.target.matches('.btn[data-category]')) { App.state.currentInventoryCategory = e.target.dataset.category; App.ui.renderInventory(); } });
            
            App.elements.bodyColorPicker.addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--ai-body-color', e.target.value);
                App.elements.bodyColorValue.textContent = e.target.value;
            });
            App.elements.eyeColorPicker.addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--ai-eye-color', e.target.value);
                App.elements.eyeColorValue.textContent = e.target.value;
            });
            App.elements.saveCustomizationsBtn.addEventListener('click', App.handlers.handleAvatarCustomizationSave);
        },

        // --- APPLICATION INITIALIZATION ---
        async init() {
            this.elements = {
                // Main layout
                authButton: document.getElementById('auth-button'), userStatusContainer: document.getElementById('user-status-container'),
                modalContainer: document.getElementById('modal-container'), header: document.getElementById('main-header'),
                // Navigation
                navLinks: document.querySelectorAll('.nav-link'), navLinksContainer: document.querySelector('.nav-links'), 
                mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
                inventoryNavLink: document.getElementById('inventory-nav-link'), profileNavLink: document.getElementById('profile-nav-link'), 
                uploadNavLink: document.getElementById('upload-nav-link'),
                // Page content
                marketGrid: document.getElementById('market-grid-container'), categoryFilters: document.getElementById('category-filters'),
                inventoryGrid: document.getElementById('inventory-grid-container'), inventoryCategoryFilters: document.getElementById('inventory-category-filters'),
                personalInfoForm: document.getElementById('personalInfoForm'),
                // Floating AI
                aiContainer: document.getElementById('floating-ai-container'),
                // Customizer Elements
                bodyColorPicker: document.getElementById('ai-body-color-picker'), bodyColorValue: document.getElementById('ai-body-color-value'),
                eyeColorPicker: document.getElementById('ai-eye-color-picker'), eyeColorValue: document.getElementById('ai-eye-color-value'),
                saveCustomizationsBtn: document.getElementById('save-customizations-btn'),
            };
            
            this.ui.init();
            this.firebase.init();
            this.bindEvents();
            
            App.elements.marketGrid.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
            await this.firebase.fetchAllProducts();
            this.ui.renderCategoryFilters();
            this.ui.renderMarketplace();
            this.firebase.auth.onAuthStateChanged(this.firebase.handleAuthStateChange.bind(this.firebase));
            
            this.ui.switchToPage('hero-page');
            this.floatingAI.init();
            this.ui.applyAIVisuals(); // Apply default visuals on start
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
