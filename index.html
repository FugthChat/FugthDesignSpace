<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fugth AI Anvil | The Future of AI Companions</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "t4j0cphhgn");
    </script>

    <style>
        :root {
            /* Modern Cyber Theme */
            --color-background: #010409;
            --color-surface: #0d1117;
            --color-surface-light: #161b22;
            --color-border: rgba(217, 249, 157, 0.1);
            --color-primary: #d9f99d; /* Cyber Lime */
            --color-secondary: #7ee787; /* Green */
            --color-text-primary: #e6edf3;
            --color-text-secondary: #7d8590;
            --color-text-heading: #ffffff;
            --color-favorite: #facc15;
            --font-family: 'Inter', sans-serif;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.2);
            
            /* AI Customization Variables */
            --ai-body-color: #d9f99d;
            --ai-eye-color: #010409;
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(217, 249, 157, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(217, 249, 157, 0); } 100% { box-shadow: 0 0 0 0 rgba(217, 249, 157, 0); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* General & Theme Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--font-family); 
            background-color: var(--color-background); 
            color: var(--color-text-primary); 
            line-height: 1.6; 
            -webkit-font-smoothing: antialiased; 
            position: relative;
            overflow-x: hidden;
            background-image:
                linear-gradient(rgba(217, 249, 157, 0.05) 1px, transparent 1px),
                linear-gradient(to right, rgba(217, 249, 157, 0.05) 1px, transparent 1px);
            background-size: 3rem 3rem;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-surface); }
        ::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-secondary); }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }
        section { padding: 100px 0; border-bottom: 1px solid var(--color-border); position: relative; }
        section:last-of-type { border-bottom: none; }
        
        h1, h2, h3 { font-weight: 700; line-height: 1.2; color: var(--color-text-heading); letter-spacing: -0.03em; }
        h1 { font-size: 4rem; } h2 { font-size: 2.5rem; } h3 { font-size: 1.75rem; }
        p { color: var(--color-text-secondary); margin-bottom: 1rem; }
        
        .section-header { text-align: center; max-width: 700px; margin: 0 auto 60px auto; }
        .text-gradient { background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; text-align: center; }
        .btn:disabled { background: #374151 !important; color: #6B7280 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; border-color: transparent !important; }
        .btn-primary { background: var(--color-primary); color: #010409; border-color: var(--color-primary); }
        .btn-primary:hover { background: var(--color-secondary); border-color: var(--color-secondary); transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(217, 249, 157, 0.2); }
        .btn-secondary { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-primary); }
        .btn-secondary:hover, .btn-secondary.active { background: var(--color-primary); border-color: var(--color-primary); color: #010409; }
        .hidden { display: none !important; }

        header { position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; transition: background 0.3s ease, border-color 0.3s ease; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid transparent; }
        header.scrolled { background: rgba(1, 4, 9, 0.7); border-bottom-color: var(--color-border); }
        nav { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; }
        .logo { font-size: 1.5rem; font-weight: 800; text-decoration: none; color: var(--color-text-primary); cursor: pointer; }
        .nav-links { list-style: none; display: flex; gap: 32px; }
        .nav-links a { text-decoration: none; color: var(--color-text-secondary); font-weight: 500; transition: color 0.2s ease; cursor: pointer; padding-bottom: 4px; border-bottom: 2px solid transparent; }
        .nav-links a:hover, .nav-links a.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .auth-container { display: flex; align-items: center; gap: 12px; }
        
        .avatar-display { width: 32px; height: 32px; position: relative; }
        .avatar-display .avatar-base { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--color-surface-light); border: 2px solid var(--color-primary); }
        .avatar-display .avatar-base img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-display .avatar-base i { font-size: 1.2rem; color: var(--color-primary); }

        #hero-page { min-height: 100vh; display: flex; align-items: center; text-align: center; padding-top: 80px; }
        .hero-content { max-width: 800px; margin: 0 auto; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .market-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; position: relative;}
        .market-card:hover { transform: translateY(-8px); border-color: var(--color-primary); box-shadow: 0 0 30px rgba(217, 249, 157, 0.1); }
        .market-card.equipped { border-color: var(--color-secondary); box-shadow: 0 0 15px rgba(126, 231, 135, 0.2); }
        .card-image { height: 160px; display: flex; align-items: center; justify-content: center; font-size: 3rem; background: var(--color-background); color: var(--color-primary); }
        .card-content { padding: 1rem; flex-grow: 1; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--color-text-primary); margin-bottom: 0.25rem; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 0 1rem 1rem 1rem; font-size: 1rem; font-weight: 600; }
        
        /* Features Showcase */
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;}
        .feature-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 2rem; transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--color-primary); }
        .feature-icon { width: 50px; height: 50px; background: var(--color-surface-light); border: 1px solid var(--color-border); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--color-primary); flex-shrink: 0; }
        .feature-card h3 { margin-bottom: 0.75rem; }
        
        /* Modal */
        .modal-container { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000; background: rgba(1, 4, 9, 0.5); backdrop-filter: blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; visibility: hidden; transition: all 0.3s ease; }
        .modal-container.show { opacity:1; visibility: visible; }
        .modal-content { background: var(--color-surface); border: 1px solid var(--color-border); padding: 2rem; border-radius: 12px; width: 90%; max-width: 400px; position:relative; }
        .modal-container.show .modal-content { transform: scale(1); }
        .modal-close { position:absolute; top: 1rem; right: 1rem; background: var(--color-surface-light); border-radius: 50%; width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; cursor:pointer;}
        .auth-form { display:flex; flex-direction:column; gap: 1rem; margin-top: 1.5rem; }
        .auth-form input { background: var(--color-background); border: 1px solid var(--color-border); padding: 0.75rem; border-radius: 6px; color: var(--color-text-primary); font-size: 1rem; }
        
        /* Profile Page */
        .profile-content { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-top: 2rem; align-items: start; }
        @media (max-width: 992px) { .profile-content { grid-template-columns: 1fr; } }
        .profile-sidebar { background: var(--color-surface); border-radius: 12px; padding: 2rem; border: 1px solid var(--color-border); position: sticky; top: 100px; text-align:center;}
        #profile-avatar-wrapper { width: 150px; height: 150px; margin: 0 auto 1rem; position: relative; }
        #profile-avatar-wrapper .avatar-display { width: 100%; height: 100%; }
        #profile-avatar-wrapper .avatar-display .avatar-base { font-size: 6rem; }
        .avatar-change-btn { position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; border-radius: 50%; background: var(--color-primary); border: none; color: #010409; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; font-size: 1rem; }
        .profile-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-text-primary); }
        .stat-label { font-size: 0.875rem; color: var(--color-text-secondary); }
        .profile-main { display: flex; flex-direction: column; gap: 2rem; }
        .profile-section { background: var(--color-surface); border-radius: 12px; padding: 2rem; border: 1px solid var(--color-border); }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
        .form-group label { text-align: left; }
        .form-group input { padding: 0.75rem; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-surface-light); color: var(--color-text-primary); font-size: 1rem; }
        #personalInfoForm button { margin-top: 1rem; }

        /* FLOATING AI STYLES */
        #floating-ai-container { position: fixed; z-index: 1001; width: 70px; height: 70px; cursor: grab; transition: top 0.1s linear, left 0.1s linear; display: flex; align-items: center; justify-content: center; }
        #floating-ai-container.idle { animation: breathe 3s ease-in-out infinite; transition: top 2s ease-in-out, left 2s ease-in-out; }
        #floating-ai-container:active { cursor: grabbing; animation: none; transition: none; }
        .ai-body { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
        .ai-skin-layer { position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; background: var(--ai-body-color); box-shadow: inset 0 -5px 15px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 50px; color: var(--ai-body-color); transition: all 0.3s ease; }
        .ai-skin-layer.icon-active { background: transparent; box-shadow: none; text-shadow: 0 0 10px var(--ai-body-color); }
        .ai-face { width: 60%; height: 60%; position: relative; z-index: 2; }
        .ai-eye { position: absolute; top: 20%; width: 12px; height: 12px; background: var(--ai-eye-color); border-radius: 50%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); transition: all 0.2s ease; }
        .ai-eye-left { left: 15%; }
        .ai-eye-right { right: 15%; }
        .ai-mouth { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); width: 20px; height: 10px; border: 2px solid var(--ai-eye-color); border-top: none; border-radius: 0 0 10px 10px; transition: all 0.2s ease; }
        .ai-face.happy .ai-mouth { height: 15px; border-radius: 0 0 15px 15px; }
        .ai-face.sad .ai-mouth { transform: translateX(-50%) rotate(180deg); top: 50%; bottom: auto; border-radius: 0 0 15px 15px; }
        .ai-face.annoyed .ai-eye { height: 4px; top: 40%; border-radius: 2px; transform: rotate(-15deg); }
        .ai-face.annoyed .ai-eye-right { transform: rotate(15deg); }
        .ai-face.annoyed .ai-mouth { width: 15px; height: 5px; border: 2px solid var(--ai-eye-color); border-radius: 5px; border-top-left-radius: 0; border-top-right-radius: 0; }
        .ai-face.blinking .ai-eye { transform: scaleY(0.1); }

        /* Customization Panel */
        #customization-panel { position: fixed; z-index: 2500; width: 280px; background: rgba(13, 17, 23, 0.7); border: 1px solid var(--color-border); border-radius: 12px; box-shadow: var(--shadow-lg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); visibility: hidden; opacity: 0; transform: translate(-50%,-50%) scale(0.95); transition: all 0.3s ease; top: 50%; left: 50%; }
        #customization-panel.show { visibility: visible; opacity: 1; transform: translate(-50%,-50%) scale(1); }
        .panel-header { padding: 12px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .panel-header h4 { font-weight: 600; color: var(--color-primary); }
        .panel-header:active { cursor: grabbing; }
        .panel-close-btn { cursor: pointer; color: var(--color-text-secondary); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .panel-close-btn:hover { background: var(--color-surface-light); color: var(--color-text-primary); }
        .panel-body { padding: 16px; display: flex; flex-direction: column; gap: 16px; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-size: 0.9rem; color: var(--color-text-secondary); }
        .control-group .shape-buttons, .control-group .expression-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .control-btn { padding: 8px; font-size: 1.2rem; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 100%; height: 30px; background-color: transparent; border: 1px solid var(--color-border); border-radius: 6px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 5px; }

        /* Marketplace */
        .card-price .fa-coins { margin-left: 0.25rem; color: var(--color-favorite); }
        .user-status { font-weight: 500; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .user-tokens { color: var(--color-primary); font-weight: 600; display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface-light); border-radius: 6px;}
        .user-tokens .fa-coins { color: var(--color-favorite); font-size: 0.9em; }

        /* Guild Pass / Pricing Page */
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; justify-content: center; }
        .pricing-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 2rem; text-align:center; }
        .pricing-card.highlight { border-color: var(--color-primary); box-shadow: 0 0 30px rgba(217, 249, 157, 0.2); }
        .pricing-card ul { list-style: none; text-align: left; margin: 2rem 0; }
        .pricing-card li { margin-bottom: 1rem; }
        .pricing-card li .fa-check-circle { color: var(--color-secondary); margin-right: 0.5rem; }
        .pricing-card li .fa-star { color: gold; margin-right: 0.5rem; }
        .price-tag { font-size: 2.5rem; font-weight: 800; margin: 0.5rem 0; color: var(--color-text-heading); }
        .price-tag span { font-size: 1rem; font-weight: 500; color: var(--color-text-secondary); }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { padding: 12px 20px; border-radius: 8px; color: #fff; margin-top: 10px; opacity: 0; transform: translateY(20px); transition: all 0.4s ease; background-color: var(--color-surface-light); border: 1px solid var(--color-border); box-shadow: var(--shadow-md); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .loader-container { width: 100%; display: flex; justify-content: center; padding: 4rem; }
        .loader { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        #radial-menu-container { position: fixed; z-index: 1002; width: 220px; height: 220px; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; transform: translate(-50%, -50%) scale(0.8); pointer-events: none; }
        #radial-menu-container.show { visibility: visible; opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        .radial-button { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(1, 4, 9, 0.7); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border: 1px solid var(--color-border); backdrop-filter: blur(10px); cursor: pointer; transition: all 0.2s ease; margin-left: -25px; margin-top: -25px; }
        .radial-button:hover { background: var(--color-primary); color: #010409;}

        /* Responsive */
        @media (max-width: 992px) {
            h1 { font-size: 3rem; } h2 { font-size: 2rem; }
            .mobile-menu-toggle { display: flex; flex-direction: column; justify-content: space-around; width: 30px; height: 25px; background: transparent; border: none; cursor: pointer; z-index: 1001; }
            .mobile-menu-toggle span { width: 100%; height: 2px; background: var(--color-text-primary); transition: all 0.3s ease; }
            .mobile-menu-toggle.active span:nth-child(1) { transform: translateY(8px) rotate(45deg); }
            .mobile-menu-toggle.active span:nth-child(2) { opacity: 0; }
            .mobile-menu-toggle.active span:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
            .nav-links { position: fixed; top: 0; right: -100%; height: 100vh; width: 80%; max-width: 400px; background: var(--color-surface); flex-direction: column; justify-content: center; padding: 80px 2rem; transition: right 0.3s ease; box-shadow: var(--shadow-lg); z-index: 1000; }
            .nav-links.active { right: 0; }
        }
    </style>
</head>
<body>
    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <header id="main-header">
        <div class="container">
            <nav>
                <a class="logo nav-link" data-target="hero-page"><i class="fa-solid fa-bolt"></i> Anvil</a>
                <ul class="nav-links">
                    <li><a class="nav-link" data-target="features-showcase">Features</a></li>
                    <li><a class="nav-link" data-target="marketplace-page">Marketplace</a></li>
                    <li><a class="nav-link" data-target="guildpass-page">Guild Pass</a></li>
                    <li><a class="nav-link" data-target="token-shop-page">Token Shop</a></li>
                    <li><a class="nav-link hidden" data-target="inventory-page" id="inventory-nav-link">My Inventory</a></li>
                    <li><a class="nav-link hidden" data-target="profile-page" id="profile-nav-link">Profile</a></li>
                </ul>
                <div class="auth-container">
                    <div class="user-status" id="user-status-container"></div>
                    <a href="#" id="auth-button" class="btn btn-secondary">Login</a>
                </div>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle"><span></span><span></span><span></span></button>
            </nav>
        </div>
    </header>

    <main>
        <section id="hero-page">
             <div class="container">
                <div class="hero-content" data-aos="fade-up">
                    <h1>Your Personal <span class="text-gradient">AI Companion</span>, Forged by You.</h1>
                    <p class="subtitle">Anvil is a powerful desktop application that lets you build, customize, and interact with a truly personal AI. Go beyond assistants—create a personality.</p>
                    <a href="https://buy.stripe.com/3cI3cv32w7aM3qbaUAgrS0a" target="_blank" class="btn btn-primary pulse-button">Get Anvil - $99.99</a>
                </div>
            </div>
        </section>

        <section id="features-showcase">
             <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>The <span class="text-gradient">Anvil Forge</span></h2>
                    <p>Powered by GGUF technology, Anvil gives you unprecedented control. Explore the core features that make Anvil unique.</p>
                </div>
                <div class="features-grid">
                    <div class="feature-card" data-aos="fade-up" data-aos-delay="100">
                        <div class="feature-icon"><i class="fas fa-shield-halved"></i></div>
                        <h3>GGUF: Private & Offline</h3>
                        <p>Your data stays on your machine. GGUF runs large models locally, ensuring your conversations and your AI's "brain" remain completely private. No internet connection required after initial setup.</p>
                    </div>
                     <div class="feature-card" data-aos="fade-up" data-aos-delay="200">
                        <div class="feature-icon"><i class="fas fa-gauge-high"></i></div>
                        <h3>Efficient Performance</h3>
                        <p>GGUF is designed for speed and efficiency. Enjoy near-instant responses and low resource usage, allowing Anvil to run smoothly alongside your other applications without slowing you down.</p>
                    </div>
                     <div class="feature-card" data-aos="fade-up" data-aos-delay="300">
                        <div class="feature-icon"><i class="fas fa-brain"></i></div>
                        <h3>Deep Customization</h3>
                        <p>Forge a true personality. Go beyond simple presets and fine-tune your AI's core traits, memory recall, and even its sense of humor to create a companion that is uniquely yours.</p>
                    </div>
                     <div class="feature-card" data-aos="fade-up" data-aos-delay="400">
                        <div class="feature-icon"><i class="fas fa-users"></i></div>
                        <h3>Community Marketplace</h3>
                        <p>Extend your AI's capabilities and appearance with a rich marketplace of skins, tools, and personalities created by Anvil Studios and the community. Your AI can evolve indefinitely.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="marketplace-page" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>The <span class="text-gradient">Marketplace</span></h2>
                    <p>Use your Fugth Tokens to acquire unique personalities, skins, and tools for your AI.</p>
                </div>
                <div class="page-content"><div class="grid-container" id="market-grid-container"></div></div>
            </div>
        </section>

        <section id="guildpass-page" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>Anvil <span class="text-gradient">Guild Pass</span></h2>
                    <p>Choose your path: get the core application or subscribe to the Guild Pass for the ultimate experience.</p>
                </div>
                <div class="pricing-grid" data-aos="fade-up">
                    <div class="pricing-card">
                        <h3>Anvil App</h3>
                        <p class="text-gradient" style="font-weight: 600;">One-Time Purchase</p>
                        <p class="price-tag">$99.99</p>
                        <ul>
                            <li><i class="fas fa-check-circle"></i> Lifetime access to the Anvil desktop app.</li>
                            <li><i class="fas fa-check-circle"></i> Full personality forging and customization tools.</li>
                            <li><i class="fas fa-check-circle"></i> Access to the community marketplace.</li>
                        </ul>
                        <a href="https://buy.stripe.com/3cI3cv32w7aM3qbaUAgrS0a" target="_blank" class="btn btn-secondary" style="width:100%;">Purchase Anvil</a>
                    </div>
                    <div class="pricing-card highlight">
                        <h3>Guild Pass</h3>
                        <p class="text-gradient" style="font-weight: 600;">Monthly Subscription</p>
                        <p class="price-tag">$7.99<span>/mo</span></p>
                         <ul>
                            <li><i class="fas fa-star"></i> **777** Fugth Tokens delivered every month.</li>
                            <li><i class="fas fa-star"></i> Exclusive skins and personalities for subscribers.</li>
                            <li><i class="fas fa-star"></i> Early access to new features and AI models.</li>
                            <li><i class="fas fa-star"></i> Special role in the community Discord.</li>
                        </ul>
                        <a href="https://buy.stripe.com/8x228rbz23YA9OzbYEgrS0b" target="_blank" class="btn btn-primary" style="width:100%;">Subscribe Now</a>
                        <p style="font-size: 0.8rem; margin-top: 1rem; color: var(--color-text-secondary);">Requires purchase of the Anvil App.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="token-shop-page" class="hidden">
            <div class="container">
                <div class="section-header" data-aos="fade-up">
                    <h2>Fugth <span class="text-gradient">Token Shop</span></h2>
                    <p>Purchase Fugth Tokens to acquire items from the marketplace and customize your AI companion.</p>
                </div>
                <div class="grid-container" data-aos="fade-up">
                     <div class="market-card">
                         <div class="card-image"><i class="fas fa-coins"></i></div>
                         <div class="card-content" style="text-align:center;">
                            <h4 class="card-title">100 Fugth Tokens</h4>
                            <p class="card-creator">A small pack to get you started.</p>
                        </div>
                         <div class="card-footer"><a href="https://buy.stripe.com/6oUdR90Uobr2d0L2o4grS0c" target="_blank" class="btn btn-primary" style="width:100%;">$0.99</a></div>
                     </div>
                     <div class="market-card">
                        <div class="card-image" style="font-size: 4rem;"><i class="fas fa-layer-group"></i></div>
                        <div class="card-content" style="text-align:center;">
                           <h4 class="card-title">550 Fugth Tokens</h4>
                           <p class="card-creator">Best value pack with a 10% bonus!</p>
                       </div>
                        <div class="card-footer"><a href="https://buy.stripe.com/fZu6oHgTmeDe6Cn3s8grS0d" target="_blank" class="btn btn-primary" style="width:100%;">$4.99</a></div>
                    </div>
                    <div class="market-card">
                        <div class="card-image" style="font-size: 5rem;"><i class="fas fa-gem"></i></div>
                        <div class="card-content" style="text-align:center;">
                           <h4 class="card-title">1200 Fugth Tokens</h4>
                           <p class="card-creator">The ultimate pack with a 20% bonus!</p>
                       </div>
                        <div class="card-footer"><a href="https://buy.stripe.com/28E5kDdHa2Uw2m78MsgrS0e" target="_blank" class="btn btn-primary" style="width:100%;">$9.99</a></div>
                    </div>
                </div>
            </div>
        </section>


        <section id="inventory-page" class="hidden">
             <div class="container">
                 <div class="section-header" data-aos="fade-up">
                         <h2>My <span class="text-gradient">Inventory</span></h2>
                         <p>All of your acquired items in one place. Equip skins and accessories to customize your AI's appearance.</p>
                 </div>
                 <div class="page-content"><div class="grid-container" id="inventory-grid-container"></div></div>
             </div>
        </section>
        
        <section id="profile-page" class="hidden">
            <div class="container">
                <div class="profile-content" data-aos="fade-up">
                    <div class="profile-sidebar">
                            <div id="profile-avatar-wrapper"></div>
                            <button class="avatar-change-btn" title="Change Avatar" id="avatarChangeBtn"><i class="fas fa-user-edit"></i></button>
                            <h3 id="profileDisplayName">User Name</h3>
                            <p id="profileEmail">user@example.com</p>
                        <div class="profile-stats">
                            <div class="stat-item"><div class="stat-value" id="totalTokens">0</div><div class="stat-label">Fugth Tokens</div></div>
                            <div class="stat-item"><div class="stat-value" id="joinDate">-</div><div class="stat-label">Joined</div></div>
                        </div>
                    </div>
                    <div class="profile-main">
                        <div class="profile-section">
                            <h3>Personal Information</h3>
                            <form id="personalInfoForm">
                                <div class="form-group">
                                    <label for="displayName">Display Name</label>
                                    <input type="text" id="displayName" name="displayName" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" name="email" disabled>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="floating-ai-container">
        <div class="ai-body">
            <div class="ai-skin-layer"></div>
            <div class="ai-face">
                <div class="ai-eye ai-eye-left"></div>
                <div class="ai-eye ai-eye-right"></div>
                <div class="ai-mouth"></div>
            </div>
        </div>
    </div>

    <div id="radial-menu-container"></div>

    <div id="customization-panel">
        <div class="panel-header" id="panel-header"><h4>Live Customizer</h4><div class="panel-close-btn" id="panel-close-btn"><i class="fas fa-times"></i></div></div>
        <div class="panel-body">
            <div class="control-group"><label for="ai-color-picker">Color</label><input type="color" id="ai-color-picker" value="#d9f99d"></div>
            <div class="control-group"><label for="ai-size-slider">Size</label><input type="range" id="ai-size-slider" min="50" max="150" value="70"></div>
            <div class="control-group">
                <label>Shape Override</label>
                <div class="shape-buttons">
                    <button class="btn btn-secondary control-btn" data-shape="default"><i class="fas fa-circle-notch"></i></button>
                    <button class="btn btn-secondary control-btn" data-shape="fa-star"><i class="fas fa-star"></i></button>
                    <button class="btn btn-secondary control-btn" data-shape="fa-heart"><i class="fas fa-heart"></i></button>
                    <button class="btn btn-secondary control-btn" data-shape="fa-square"><i class="fas fa-square"></i></button>
                </div>
            </div>
            <div class="control-group">
                <label>Expressions</label>
                <div class="expression-buttons">
                    <button class="btn btn-secondary control-btn" data-face="happy"><i class="fas fa-smile"></i></button>
                    <button class="btn btn-secondary control-btn" data-face="annoyed"><i class="fas fa-angry"></i></button>
                    <button class="btn btn-secondary control-btn" data-face="sad"><i class="fas fa-frown"></i></button>
                    <button class="btn btn-secondary control-btn" data-face="neutral"><i class="fas fa-meh"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
    'use strict';
    document.addEventListener('DOMContentLoaded', () => {
        // --- INITIALIZATION & GLOBAL STATE ---
        AOS.init({ duration: 800, once: true, offset: 50 });

        const firebaseConfig = {
            apiKey: "AIzaSyBlqTqN1gUoCpuqPqmpLdtZdJHVFbTWyTs",
            authDomain: "fugthdesign-91744.firebaseapp.com",
            projectId: "fugthdesign-91744",
            storageBucket: "fugthdesign-91744.appspot.com",
            messagingSenderId: "797596632132",
            appId: "1:797596632132:web:2c2ebfa54c908e09a26811"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let userData = {};
        let userInventory = new Map();
        let allProductsCache = new Map();
        let equippedItems = { skin: null };

        const elements = {
            authButton: document.getElementById('auth-button'),
            userStatusContainer: document.getElementById('user-status-container'),
            marketGrid: document.getElementById('market-grid-container'),
            inventoryGrid: document.getElementById('inventory-grid-container'),
            modalContainer: document.getElementById('modal-container'),
            inventoryNavLink: document.getElementById('inventory-nav-link'),
            profileNavLink: document.getElementById('profile-nav-link'),
            navLinks: document.querySelectorAll('.nav-link'),
            header: document.getElementById('main-header'),
            personalInfoForm: document.getElementById('personalInfoForm'),
            aiContainer: document.getElementById('floating-ai-container'),
            aiSkinLayer: document.querySelector('.ai-skin-layer'),
            radialMenu: document.getElementById('radial-menu-container'),
            customizationPanel: document.getElementById('customization-panel'),
            mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
            navLinksContainer: document.querySelector('.nav-links')
        };
        
        let isDragging = false, isPanelDragging = false, offsetX, offsetY, panelOffsetX, panelOffsetY;
        let moveTimeout, inactivityTimer, annoyanceInterval;
        let lastInteractionTime = Date.now();
        let isAnnoying = false;
        let mouseX = window.innerWidth / 2, mouseY = window.innerHeight / 2;

        function setAIFace(face) {
            const aiFaceEl = elements.aiContainer.querySelector('.ai-face');
            if (aiFaceEl) {
                aiFaceEl.className = 'ai-face';
                if (face && face !== 'neutral') aiFaceEl.classList.add(face);
            }
        }

        function applyAIVisuals({ product, shapeOverride }) {
            elements.aiSkinLayer.innerHTML = '';
            elements.aiSkinLayer.classList.remove('icon-active');
            let iconClass = (shapeOverride && shapeOverride !== 'default') ? shapeOverride : (product?.category === 'skin' ? product.icon : null);
            if (iconClass) {
                elements.aiSkinLayer.innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
                elements.aiSkinLayer.classList.add('icon-active');
            }
        }
        
        function updateFloatingAIVisuals() {
            const skinProduct = equippedItems.skin ? allProductsCache.get(equippedItems.skin) : null;
            applyAIVisuals({ product: skinProduct });
        }
        
        const startDrag = (e) => { if (isAnnoying) return; isDragging = true; elements.aiContainer.classList.remove('idle'); clearTimeout(moveTimeout); offsetX = e.clientX - elements.aiContainer.offsetLeft; offsetY = e.clientY - elements.aiContainer.offsetTop; document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', dragEnd, { once: true }); };
        const dragMove = (e) => { if (!isDragging) return; elements.aiContainer.style.left = `${e.clientX - offsetX}px`; elements.aiContainer.style.top = `${e.clientY - offsetY}px`; if(elements.radialMenu.classList.contains('show')) updateRadialMenuPosition(); };
        const dragEnd = () => { isDragging = false; elements.aiContainer.classList.add('idle'); scheduleNextMove(); document.removeEventListener('mousemove', dragMove); };
        
        function resetInteractionTimer() { lastInteractionTime = Date.now(); }
        document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; resetInteractionTimer(); });
        document.addEventListener('click', resetInteractionTimer);
        function startAnnoyanceCheck() { if (inactivityTimer) clearInterval(inactivityTimer); inactivityTimer = setInterval(() => { if (Date.now() - lastInteractionTime > 30000 && !isAnnoying && !isDragging) beginAnnoying(); }, 2000); }
        function beginAnnoying() { isAnnoying = true; clearTimeout(moveTimeout); elements.aiContainer.classList.remove('idle'); setAIFace('sad'); annoyanceInterval = setInterval(() => { const rect = elements.aiContainer.getBoundingClientRect(); elements.aiContainer.style.left = `${rect.left + (mouseX - rect.left - rect.width/2) * 0.08}px`; elements.aiContainer.style.top = `${rect.top + (mouseY - rect.top - rect.height/2) * 0.08}px`; }, 30); }
        function stopAnnoying() { isAnnoying = false; clearInterval(annoyanceInterval); setAIFace('happy'); moveAiRandomly(true); setTimeout(() => setAIFace('neutral'), 2000); }
        
        function moveAiRandomly(immediate = false) {
             if (isDragging) return;
             const maxX = window.innerWidth - elements.aiContainer.clientWidth;
             const maxY = window.innerHeight - elements.aiContainer.clientHeight;
             const newX = Math.random() * maxX;
             const newY = Math.random() * maxY;
             if (immediate) {
                elements.aiContainer.classList.remove('idle');
                elements.aiContainer.style.transition = 'top 0.5s ease, left 0.5s ease';
             }
             elements.aiContainer.style.left = `${newX}px`;
             elements.aiContainer.style.top = `${newY}px`;
             if (immediate) setTimeout(() => { elements.aiContainer.classList.add('idle'); elements.aiContainer.style.transition = ''; scheduleNextMove(); }, 500);
             else scheduleNextMove();
        }
        
        const scheduleNextMove = () => { clearTimeout(moveTimeout); if (isAnnoying || isDragging || elements.customizationPanel.classList.contains('show')) return; moveTimeout = setTimeout(() => moveAiRandomly(false), 8000); };
        
        async function initializeApp() {
            elements.marketGrid.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
            await fetchAllProducts();
            auth.onAuthStateChanged(handleAuthStateChange);
            switchToPage('hero-page');
        }

        async function handleAuthStateChange(user) {
            currentUser = user;
            if (user) await onLogin(); else onLogout();
        }

        async function onLogin() {
            await fetchUserData();
            await Promise.all([fetchEquippedItems(), fetchUserInventory(), checkForDailyLogin()]);
            updateNavForLoggedInUser();
            updateFloatingAIVisuals();
            updateProfilePageUI();
            filterAndRenderProducts();
        }

        function onLogout() {
            userData = {};
            userInventory.clear();
            equippedItems = { skin: null };
            updateUIForLoggedOutUser();
            filterAndRenderProducts();
        }

        async function fetchUserData() {
            const userRef = db.collection('users').doc(currentUser.uid);
            const userDoc = await userRef.get();
            if (userDoc.exists) {
                userData = userDoc.data();
            } else { // Handle first-time login for pre-existing auth users
                const initialData = { displayName: currentUser.displayName, email: currentUser.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tokens: 50, lastLogin: new Date() };
                await userRef.set(initialData);
                userData = initialData;
            }
        }

        async function checkForDailyLogin() {
            const today = new Date().toISOString().split('T')[0];
            const lastLoginDate = userData.lastLogin?.toDate().toISOString().split('T')[0];
            if (today !== lastLoginDate) {
                const newTokens = (userData.tokens || 0) + 7;
                await db.collection('users').doc(currentUser.uid).update({ tokens: newTokens, lastLogin: new Date() });
                userData.tokens = newTokens;
                showToast(`+7 Tokens for your daily login!`);
            }
            // Placeholder for monthly subscription token drop
            // In a real app, a secure backend would verify the Stripe subscription
            // and add tokens. For now, we advertise it on the Guild Pass page.
        }

        async function fetchAllProducts() {
            const snapshot = await db.collection('products').get();
            if (snapshot.empty) { await seedDefaultProducts(); await fetchAllProducts(); }
            else { snapshot.forEach(doc => allProductsCache.set(doc.id, { id: doc.id, ...doc.data() })); }
        }

        async function fetchUserInventory() {
            if (!currentUser) return;
            userInventory.clear();
            const snapshot = await db.collection('user_inventory').doc(currentUser.uid).collection('items').get();
            snapshot.forEach(doc => userInventory.set(doc.id, doc.data()));
        }

        async function fetchEquippedItems() {
            if (!currentUser) { equippedItems = { skin: null }; return; }
            const doc = await db.collection('users').doc(currentUser.uid).collection('settings').doc('avatar').get();
            equippedItems = doc.exists ? { skin: doc.data().skin || null } : { skin: null };
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        function switchToPage(pageId) {
            document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden'));
            const targetPage = document.getElementById(pageId);
            if(targetPage) { targetPage.classList.remove('hidden'); AOS.refresh(); }
            elements.navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === pageId));
            window.scrollTo(0, 0);
        }

        function updateNavForLoggedInUser() {
            elements.authButton.textContent = 'Logout';
            elements.inventoryNavLink.classList.remove('hidden');
            elements.profileNavLink.classList.remove('hidden');
            updateAvatarDisplay();
        }

        function updateUIForLoggedOutUser() {
            elements.userStatusContainer.innerHTML = '';
            elements.authButton.textContent = 'Login';
            elements.inventoryNavLink.classList.add('hidden');
            elements.profileNavLink.classList.add('hidden');
            updateFloatingAIVisuals();
            switchToPage('hero-page');
        }

        function updateAvatarDisplay() {
            if (!currentUser) return;
            const name = userData.displayName || currentUser.email.split('@')[0];
            const baseAvatarUrl = currentUser.photoURL || `https://api.dicebear.com/6.x/pixel-art/svg?seed=${encodeURIComponent(name)}`;
            const tokenBalance = userData.tokens || 0;
            let avatarBaseHtml;
            if (equippedItems.skin && allProductsCache.has(equippedItems.skin)) {
                const skinProduct = allProductsCache.get(equippedItems.skin);
                avatarBaseHtml = `<div class="avatar-base"><i class="fa-solid ${skinProduct.icon}"></i></div>`;
            } else {
                avatarBaseHtml = `<div class="avatar-base"><img src="${baseAvatarUrl}" alt="User Avatar"></div>`;
            }
            elements.userStatusContainer.innerHTML = `<div class="user-tokens"><span>${tokenBalance}</span> <i class="fas fa-coins"></i></div><div class="avatar-display">${avatarBaseHtml}</div><span>${name}</span>`;
            if (document.getElementById('profile-avatar-wrapper')) {
                document.getElementById('profile-avatar-wrapper').innerHTML = `<div class="avatar-display">${avatarBaseHtml}</div>`;
            }
        }
        
        function updateProfilePageUI() {
            if (!currentUser || !userData) return;
            updateAvatarDisplay();
            document.getElementById('profileDisplayName').textContent = userData.displayName;
            document.getElementById('profileEmail').textContent = userData.email;
            document.getElementById('displayName').value = userData.displayName;
            document.getElementById('email').value = userData.email;
            document.getElementById('totalTokens').textContent = userData.tokens || 0;
            const joinDate = userData.createdAt?.toDate();
            if(joinDate) document.getElementById('joinDate').textContent = joinDate.toLocaleDateString();
        }
        
        function openAuthModal(showSignup = false) {
            const loginHidden = showSignup ? 'hidden' : '';
            const signupHidden = !showSignup ? 'hidden' : '';
            elements.modalContainer.innerHTML = `<div class="modal-content"><div class="modal-close"><i class="fa-solid fa-times"></i></div><div id="login-view" class="${loginHidden}"><h3>Login</h3><form id="login-form" class="auth-form"><p class="form-error" style="color:red; text-align:center;"></p><input type="email" name="email" placeholder="Email" required><input type="password" name="password" placeholder="Password" required><button type="submit" class="btn btn-primary" style="width:100%;">Login</button></form><p style="text-align:center; margin-top:1rem;">No account? <a href="#" id="show-signup" style="color:var(--color-primary)">Sign Up</a></p></div><div id="signup-view" class="${signupHidden}"><h3>Create Account</h3><form id="signup-form" class="auth-form"><p class="form-error" style="color:red; text-align:center;"></p><input type="email" name="email" placeholder="Email" required><input type="password" name="password" placeholder="Password" required><button type="submit" class="btn btn-primary" style="width:100%;">Create</button></form><p style="text-align:center; margin-top:1rem;">Have an account? <a href="#" id="show-login" style="color:var(--color-primary)">Login</a></p></div></div>`;
            elements.modalContainer.classList.add('show');
            elements.modalContainer.querySelector('.modal-close').addEventListener('click', closeModal);
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('signup-form')?.addEventListener('submit', handleSignup);
            document.getElementById('show-signup').addEventListener('click', e => { e.preventDefault(); openAuthModal(true); });
            document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); openAuthModal(false); });
        }

        function closeModal() { if(elements.modalContainer) elements.modalContainer.classList.remove('show'); }

        async function handleLogin(e) { e.preventDefault(); try { await auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value); closeModal(); showToast(`Welcome back!`); } catch (err) { e.target.querySelector('.form-error').textContent = err.message; } }
        
        async function handleSignup(e) {
            e.preventDefault();
            try {
                const cred = await auth.createUserWithEmailAndPassword(e.target.email.value, e.target.password.value);
                const initialName = cred.user.email.split('@')[0];
                await cred.user.updateProfile({ displayName: initialName });
                await db.collection('users').doc(cred.user.uid).set({ displayName: initialName, email: cred.user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(), tokens: 50, lastLogin: new Date() });
                closeModal();
                showToast(`Welcome! You start with 50 Fugth Tokens!`);
            } catch (err) { e.target.querySelector('.form-error').textContent = err.message; }
        }
        
        function filterAndRenderProducts() {
            if (!elements.marketGrid) return;
            const products = Array.from(allProductsCache.values());
            elements.marketGrid.innerHTML = products.length ? products.map(p => createProductCard(p, 'marketplace')).join('') : `<p>No items found.</p>`;
        }

        function renderInventory() {
            if (!elements.inventoryGrid) return;
            if (userInventory.size === 0) { elements.inventoryGrid.innerHTML = "<p style='text-align: center; grid-column: 1 / -1;'>Inventory is empty.</p>"; return; }
            const inventoryArray = Array.from(userInventory.keys()).map(id => ({ id, ...allProductsCache.get(id) })).filter(item => item.name);
            elements.inventoryGrid.innerHTML = inventoryArray.map(product => createProductCard(product, 'inventory')).join('');
        }

        function createProductCard(product, context) {
            if (!product) return '';
            const isOwned = userInventory.has(product.id);
            const isEquipped = equippedItems.skin === product.id;
            let footerHtml = '';

            if (context === 'inventory') {
                if (product.category === 'skin') footerHtml = `<button class="btn btn-primary equip-btn" data-product-id="${product.id}">${isEquipped ? 'Unequip' : 'Equip'}</button>`;
                else footerHtml = `<button class="btn btn-secondary" disabled>Cannot Equip</button>`;
            } else {
                const priceText = product.price === 0 ? 'Free' : `${product.price} <i class="fas fa-coins"></i>`;
                const actionButton = isOwned ? `<button class="btn btn-disabled">Owned</button>` : `<button class="btn btn-primary" onclick="window.handlePurchase('${product.id}')">Get</button>`;
                footerHtml = `<span class="card-price text-gradient">${priceText}</span>${actionButton}`;
            }
            return `<div class="market-card ${isEquipped ? 'equipped' : ''}" data-product-id="${product.id}" data-aos="fade-up"><div class="card-image"><i class="fa-solid fa-${product.icon}"></i></div><div class="card-content"><h4 class="card-title">${product.name}</h4><p class="card-creator">by ${product.creator}</p></div><div class="card-footer">${footerHtml}</div></div>`;
        }

        async function handleEquipToggle(productId) {
            if (!currentUser) return;
            const newSkin = equippedItems.skin === productId ? null : productId;
            try {
                await db.collection('users').doc(currentUser.uid).collection('settings').doc('avatar').set({ skin: newSkin }, { merge: true });
                equippedItems.skin = newSkin;
                updateFloatingAIVisuals();
                updateAvatarDisplay();
                renderInventory();
                showToast(`Item ${newSkin ? 'equipped' : 'unequipped'}.`);
            } catch (error) { showToast("Couldn't save your choice."); }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const newName = document.getElementById('displayName').value.trim();
            if (!currentUser || !newName || newName === userData.displayName) return;
            const saveButton = e.target.querySelector('button[type="submit"]');
            saveButton.textContent = 'Saving...'; saveButton.disabled = true;
            try {
                await currentUser.updateProfile({ displayName: newName });
                await db.collection('users').doc(currentUser.uid).update({ displayName: newName });
                userData.displayName = newName; // Update local state immediately
                updateNavForLoggedInUser();
                updateProfilePageUI();
                showToast('Profile updated successfully!');
            } catch (error) { showToast('Failed to update profile.'); }
            finally { saveButton.textContent = 'Save Changes'; saveButton.disabled = false; }
        }
        
        async function handlePurchase(productId) {
            if (!currentUser) { showToast('Please log in to make a purchase.'); return; }
            const product = allProductsCache.get(productId);
            if (!product) { showToast('Item not found.'); return; }
            if (userData.tokens < product.price) { showToast('Not enough Fugth Tokens!'); return; }
            const newBalance = userData.tokens - product.price;
            try {
                const batch = db.batch();
                batch.update(db.collection('users').doc(currentUser.uid), { tokens: newBalance });
                batch.set(db.collection('user_inventory').doc(currentUser.uid).collection('items').doc(productId), { acquiredAt: firebase.firestore.FieldValue.serverTimestamp() });
                await batch.commit();
                userData.tokens = newBalance;
                userInventory.set(productId, { acquiredAt: new Date() });
                showToast(`Purchased ${product.name}!`);
                updateNavForLoggedInUser();
                updateProfilePageUI();
                filterAndRenderProducts();
            } catch (error) { showToast("Purchase failed. Please try again."); }
        }
        window.handlePurchase = handlePurchase;

        async function seedDefaultProducts() { const prods = [ { name: "Glitch Skin", icon: "fa-ghost", category: "skin", price: 75, creator: "Community Artist" }, { name: "Fire Skin", icon: "fa-fire", category: "skin", price: 0, creator: "Anvil Studios" }, { name: "Top Hat", icon: "fa-hat-wizard", category: "accessory", price: 25, creator: "Anvil Studios" }, { name: "Logic Core", icon: "fa-brain", category: "personality", price: 150, creator: "Anvil Studios" }, { name: "System Monitor", icon: "fa-chart-line", category: "tool", price: 100, creator: "Community Dev" } ]; const batch = db.batch(); prods.forEach(p => batch.set(db.collection("products").doc(), p)); await batch.commit(); }

        elements.navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); const targetId = e.currentTarget.dataset.target; if ((targetId.includes('inventory') || targetId.includes('profile')) && !currentUser) { openAuthModal(); return; } if (targetId === 'inventory-page') renderInventory(); switchToPage(targetId); elements.navLinksContainer.classList.remove('active'); elements.mobileMenuToggle.classList.remove('active'); }));
        window.addEventListener('scroll', () => elements.header.classList.toggle('scrolled', window.scrollY > 50));
        elements.authButton.addEventListener('click', e => { e.preventDefault(); currentUser ? auth.signOut() : openAuthModal(); });
        document.addEventListener('click', e => { if (e.target.closest('.equip-btn')) handleEquipToggle(e.target.closest('.equip-btn').dataset.productId); });
        elements.personalInfoForm?.addEventListener('submit', handleProfileUpdate);
        document.querySelector('.filter-controls')?.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { document.querySelector('.filter-controls .active')?.classList.remove('active'); e.target.classList.add('active'); filterAndRenderProducts(e.target.dataset.filter); } });
        elements.mobileMenuToggle.addEventListener('click', () => { elements.mobileMenuToggle.classList.toggle('active'); elements.navLinksContainer.classList.toggle('active'); });

        // --- STARTUP ---
        initializeApp();
        elements.aiContainer.classList.add('idle');
        scheduleNextMove();
        startAnnoyanceCheck();
    });
    </script>
</body>
</html>
