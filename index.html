<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FugthWebCode</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/neat.min.css">
    
    <style>
        :root {
            --bg-primary: #f0f0f0;
            --bg-secondary: #ffffff;
            --bg-header: #e0e0e0;
            --text-primary: #111;
            --text-secondary: #444;
            --border-color: #ccc;
            --resizer-color: #ccc;
            --button-bg: #007bff;
            --button-text: #fff;
            --header-height: 50px;
        }

        body.dark-theme {
            --bg-primary: #282a36;
            --bg-secondary: #21222c;
            --bg-header: #191a21;
            --text-primary: #f8f8f2;
            --text-secondary: #bd93f9;
            --border-color: #44475a;
            --resizer-color: #44475a;
            --button-bg: #50fa7b;
            --button-text: #282a36;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            height: var(--header-height);
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        header h1 {
            font-size: 1.5em;
            margin: 0;
            color: var(--text-secondary);
        }

        header .controls button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            transition: opacity 0.2s;
        }

        header .controls button:hover {
            opacity: 0.85;
        }

        .container {
            display: flex;
            flex-grow: 1;
        }

        #editor-pane {
            display: flex;
            flex-direction: column;
            width: 50%;
            height: 100%;
        }

        .CodeMirror {
            flex-grow: 1;
            height: 100% !important;
            font-size: 15px;
        }

        #resizer {
            width: 8px;
            background-color: var(--resizer-color);
            cursor: col-resize;
            flex-shrink: 0;
        }

        #output-pane {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #preview-frame {
            flex: 3; /* Give more space to preview */
            width: 100%;
            height: 100%;
            border: none;
            background-color: #fff;
        }

        #console-container {
            flex: 1; /* Give less space to console */
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background-color: var(--bg-header);
            font-weight: bold;
        }

        #console-header button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            cursor: pointer;
        }

        #console-output {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            color: var(--text-primary);
        }

        .log-msg { color: var(--text-primary); }
        .log-error { color: #ff5555; }
        .log-warn { color: #f1fa8c; }
        .log-info { color: #8be9fd; }
        
        #settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
    </style>
</head>
<body class="dark-theme">

    <header>
        <h1>FugthWebCode</h1>
        <div class="controls">
            <button id="save-btn">Save</button>
            <button id="export-btn">Export HTML</button>
            <button id="settings-btn">Settings ⚙️</button>
        </div>
    </header>

    <div class="container">
        <div id="editor-pane">
            <textarea id="code-canvas"></textarea>
        </div>

        <div id="resizer"></div>

        <div id="output-pane">
            <iframe id="preview-frame" title="Live Preview"></iframe>
            <div id="console-container">
                <div id="console-header">
                    <span>Console</span>
                    <button id="clear-console-btn">Clear</button>
                </div>
                <div id="console-output"></div>
            </div>
        </div>
    </div>
    
    <div id="settings-modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Settings</h2>
            <hr>
            <h4>Theme</h4>
            <input type="radio" id="dark-theme" name="theme" value="dark" checked>
            <label for="dark-theme">Dark (Dracula)</label>
            <br>
            <input type="radio" id="light-theme" name="theme" value="light">
            <label for="light-theme">Light (Neat)</label>
            <hr>
            <h4>External Libraries</h4>
            <input type="checkbox" id="include-bootstrap-css">
            <label for="include-bootstrap-css">Include Bootstrap CSS</label>
            <br>
            <input type="checkbox" id="include-jquery">
            <label for="include-jquery">Include jQuery</label>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.js"></script>

    <script>
        // --- DOM Elements ---
        const editorPane = document.getElementById('editor-pane');
        const resizer = document.getElementById('resizer');
        const previewFrame = document.getElementById('preview-frame');
        const consoleOutput = document.getElementById('console-output');
        const clearConsoleBtn = document.getElementById('clear-console-btn');
        const saveBtn = document.getElementById('save-btn');
        const exportBtn = document.getElementById('export-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const modalClose = document.querySelector('.modal-close');
        
        let settings = {
            theme: 'dark',
            includeBootstrap: false,
            includeJQuery: false
        };

        // --- Editor Initialization (CodeMirror) ---
        const mainEditor = CodeMirror.fromTextArea(document.getElementById('code-canvas'), {
            mode: 'htmlmixed',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseTags: true,
        });

        // --- Core Functionality ---
        function updatePreview() {
            let content = mainEditor.getValue();

            const consoleInterceptor = `
                <script>
                    const originalConsole = window.console;
                    window.console = {
                        ...originalConsole,
                        log: (...args) => { window.parent.postMessage({ type: 'log', message: args }, '*'); originalConsole.log(...args); },
                        error: (...args) => { window.parent.postMessage({ type: 'error', message: args }, '*'); originalConsole.error(...args); },
                        warn: (...args) => { window.parent.postMessage({ type: 'warn', message: args }, '*'); originalConsole.warn(...args); },
                        info: (...args) => { window.parent.postMessage({ type: 'info', message: args }, '*'); originalConsole.info(...args); }
                    };
                    window.addEventListener('error', e => { window.parent.postMessage({ type: 'error', message: [e.message] }, '*'); });
                <\/script>
            `;

            // Inject libraries and console interceptor intelligently
            if (settings.includeBootstrap && content.includes('</head>')) {
                const bootstrapLink = '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">';
                content = content.replace('</head>', `${bootstrapLink}</head>`);
            }
            if (content.includes('</body>')) {
                let scriptsToInject = consoleInterceptor;
                if (settings.includeJQuery) {
                    scriptsToInject = `<script src="https://code.jquery.com/jquery-3.7.1.min.js"><\/script>` + scriptsToInject;
                }
                content = content.replace('</body>', `${scriptsToInject}</body>`);
            } else {
                 content += consoleInterceptor; // Fallback
            }
            
            previewFrame.srcdoc = content;
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        const debouncedUpdate = debounce(updatePreview, 500);

        mainEditor.on('change', debouncedUpdate);

        // --- Console Forwarding ---
        window.addEventListener('message', (event) => {
            const { type, message } = event.data;
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.textContent = `> ${message.map(m => typeof m === 'object' ? JSON.stringify(m) : m).join(' ')}`;
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        });

        clearConsoleBtn.addEventListener('click', () => {
            consoleOutput.innerHTML = '';
        });

        // --- Pane Resizing ---
        let isResizing = false;
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const totalWidth = document.querySelector('.container').offsetWidth;
            const newEditorWidth = e.clientX;
            const newEditorPercent = (newEditorWidth / totalWidth) * 100;
            if (newEditorPercent > 10 && newEditorPercent < 90) {
                editorPane.style.width = `${newEditorPercent}%`;
            }
        });

        window.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
        });

        // --- Persistence (LocalStorage) ---
        function saveCode() {
            const data = {
                code: mainEditor.getValue(),
                settings: settings
            };
            localStorage.setItem('fugthwebcode_single_canvas_data', JSON.stringify(data));
            saveBtn.textContent = 'Saved!';
            setTimeout(() => { saveBtn.textContent = 'Save' }, 1500);
        }

        function loadCode() {
            const data = JSON.parse(localStorage.getItem('fugthwebcode_single_canvas_data'));
            if (data) {
                mainEditor.setValue(data.code || '');
                settings = data.settings || settings;
                applySettings();
            } else {
                // Set a default boilerplate for new users
                mainEditor.setValue('<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <title>Document</title>\n    <style>\n        body {\n            font-family: sans-serif;\n            background-color: #222;\n            color: #eee;\n        }\n    </style>\n</head>\n<body>\n    <h1>Hello, World!</h1>\n    \n    <script>\n        console.log("Welcome to FugthWebCode!");\n    </script>\n</body>\n</html>');
            }
        }

        saveBtn.addEventListener('click', saveCode);

        // --- Export to HTML ---
        exportBtn.addEventListener('click', () => {
            const blob = new Blob([mainEditor.getValue()], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fugthwebcode.html';
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // --- Settings Modal & Theming ---
        function applySettings() {
            const isDark = settings.theme === 'dark';
            document.body.className = isDark ? 'dark-theme' : '';
            mainEditor.setOption('theme', isDark ? 'dracula' : 'neat');
            document.getElementById('dark-theme').checked = isDark;
            document.getElementById('light-theme').checked = !isDark;
            
            document.getElementById('include-bootstrap-css').checked = settings.includeBootstrap;
            document.getElementById('include-jquery').checked = settings.includeJQuery;
            
            updatePreview();
        }
        
        settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
        modalClose.addEventListener('click', () => settingsModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
        
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                settings.theme = e.target.value;
                applySettings();
            });
        });
        
        document.getElementById('include-bootstrap-css').addEventListener('change', e => {
            settings.includeBootstrap = e.target.checked;
            updatePreview();
        });
        document.getElementById('include-jquery').addEventListener('change', e => {
            settings.includeJQuery = e.target.checked;
            updatePreview();
        });

        // --- Initial Load ---
        loadCode();
        updatePreview();
    </script>

</body>
</html>
